/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { DataSource } from '@angular/cdk/table';
import { BehaviorSubject, combineLatest, merge, of, Subject, Subscription } from 'rxjs';
import { Order } from '@datorama/akita';
import { AkitaFiltersPlugin } from '../akita-filters-plugin';
import { map, takeUntil } from 'rxjs/operators';
/**
 * @template S, E
 */
var /**
 * @template S, E
 */
AkitaMatDataSource = /** @class */ (function (_super) {
    tslib_1.__extends(AkitaMatDataSource, _super);
    /**
     * Data source to use an Akita EntityStore with a Material table
     * @see : https://material.angular.io/components/table/overview
     *
     * @param query string : [Mandatory] the akita Query Entity, you wan to use to this data source.
     * @param akitaFilters string [Optional] If you want to provide an AkitaFilters that you use externally. Else it will create a new one.
     */
    function AkitaMatDataSource(query, akitaFilters) {
        var _this = _super.call(this) || this;
        _this._paginator = null;
        _this._sort = null;
        /**
         * Used to react to internal changes of the paginator that are made by the data source itself.
         */
        _this._internalPageChanges = new Subject();
        /**
         * Stream emitting render data to the table (depends on ordered data changes).
         */
        _this._renderData = new BehaviorSubject([]);
        /**
         * Used to react to internal changes of the paginator that are made by the data source itself.
         */
        _this._disconnect = new Subject();
        /**
         * Subscription to the changes that should trigger an update to the table's rendered rows, such
         * as filtering, sorting, pagination, or base data changes.
         */
        _this._renderChangesSubscription = Subscription.EMPTY;
        _this._dataQuery = query;
        _this._filters = akitaFilters ? akitaFilters : new AkitaFiltersPlugin(query);
        _this._hasCustomFilters = !!akitaFilters;
        _this._count$ = new BehaviorSubject(0);
        /** @type {?} */
        var count = 0;
        // @ts-ignore ignore, as without options, we will allways have an Array.
        _this._selectAllByFilter$ = _this._filters.selectAllByFilters();
        _this._updateChangeSubscription();
        return _this;
    }
    Object.defineProperty(AkitaMatDataSource.prototype, "filter", {
        /**
         * @param searchQuery teh string use to search
         */
        set: /**
         * @param {?} searchQuery teh string use to search
         * @return {?}
         */
        function (searchQuery) {
            this.search = searchQuery;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AkitaMatDataSource.prototype, "search", {
        /**
         * filter all the list by a search term.
         *
         * use like a property :
         * akitaMatDataSourceInstance.search = 'term';
         * @param searchQuery the string use to search
         */
        set: /**
         * filter all the list by a search term.
         *
         * use like a property :
         * akitaMatDataSourceInstance.search = 'term';
         * @param {?} searchQuery the string use to search
         * @return {?}
         */
        function (searchQuery) {
            if (searchQuery === '') {
                this._filters.removeFilter('search');
            }
            else {
                this._filters.setFilter({ id: 'search', value: searchQuery });
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AkitaMatDataSource.prototype, "sort", {
        /**
         * Instance of the MatSort directive used by the table to control its sorting. Sort changes
         * emitted by the MatSort will trigger an update to the table's rendered data.
         */
        set: /**
         * Instance of the MatSort directive used by the table to control its sorting. Sort changes
         * emitted by the MatSort will trigger an update to the table's rendered data.
         * @param {?} sort
         * @return {?}
         */
        function (sort) {
            var _this = this;
            this._sort = sort;
            sort.sortChange.pipe(takeUntil(this._disconnect)).subscribe((/**
             * @param {?} sortValue
             * @return {?}
             */
            function (sortValue) {
                _this._filters.setSortBy({
                    sortBy: (/** @type {?} */ (sortValue.active)),
                    sortByOrder: sortValue.direction === 'desc' ? Order.DESC : Order.ASC
                });
            }));
            sort.initialized.subscribe((/**
             * @return {?}
             */
            function () {
                _this.setDefaultSort((/** @type {?} */ (sort.active)), sort.direction === 'desc' ? Order.DESC : Order.ASC);
            }));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AkitaMatDataSource.prototype, "paginator", {
        /**
         * Instance of the MatPaginator component used by the table to control what page of the data is
         * displayed. Page changes emitted by the MatPaginator will trigger an update to the
         * table's rendered data.
         *
         * Note that the data source uses the paginator's properties to calculate which page of data
         * should be displayed. If the paginator receives its properties as template inputs,
         * e.g. `[pageLength]=100` or `[pageIndex]=1`, then be sure that the paginator's view has been
         * initialized before assigning it to this data source.
         */
        get: /**
         * Instance of the MatPaginator component used by the table to control what page of the data is
         * displayed. Page changes emitted by the MatPaginator will trigger an update to the
         * table's rendered data.
         *
         * Note that the data source uses the paginator's properties to calculate which page of data
         * should be displayed. If the paginator receives its properties as template inputs,
         * e.g. `[pageLength]=100` or `[pageIndex]=1`, then be sure that the paginator's view has been
         * initialized before assigning it to this data source.
         * @return {?}
         */
        function () {
            return this._paginator;
        },
        set: /**
         * @param {?} paginator
         * @return {?}
         */
        function (paginator) {
            this._paginator = paginator;
            this._updateChangeSubscription();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AkitaMatDataSource.prototype, "AkitaFilters", {
        /**
         * @deprecated use get akitaFiltersPlugin
         */
        get: /**
         * @deprecated use get akitaFiltersPlugin
         * @return {?}
         */
        function () {
            return this._filters;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AkitaMatDataSource.prototype, "akitaFiltersPlugIn", {
        /**
         * Access to AkitaFiltersPlugins, usefull to interact with all filters
         */
        get: /**
         * Access to AkitaFiltersPlugins, usefull to interact with all filters
         * @return {?}
         */
        function () {
            return this._filters;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @private
     * @param {?} value
     * @return {?}
     */
    AkitaMatDataSource.prototype._updateCount = /**
     * @private
     * @param {?} value
     * @return {?}
     */
    function (value) {
        /** @type {?} */
        var count = value.length ? value.length : 0;
        if (count !== this._count$.getValue()) {
            this._count$.next(count);
            this._updatePaginator(count);
        }
    };
    /**
     * Paginate the data (client-side). If you're using server-side pagination,
     * this would be replaced by requesting the appropriate data from the server.
     */
    /**
     * Paginate the data (client-side). If you're using server-side pagination,
     * this would be replaced by requesting the appropriate data from the server.
     * @private
     * @param {?} data
     * @return {?}
     */
    AkitaMatDataSource.prototype._pageData = /**
     * Paginate the data (client-side). If you're using server-side pagination,
     * this would be replaced by requesting the appropriate data from the server.
     * @private
     * @param {?} data
     * @return {?}
     */
    function (data) {
        this._updateCount(data);
        if (!this.paginator) {
            return data;
        }
        /** @type {?} */
        var startIndex = this.paginator.pageIndex * this.paginator.pageSize;
        return data.slice(startIndex, startIndex + this.paginator.pageSize);
    };
    /**
     *  add a filter to filters plugins
     */
    /**
     *  add a filter to filters plugins
     * @param {?} filter
     * @return {?}
     */
    AkitaMatDataSource.prototype.addFilter = /**
     *  add a filter to filters plugins
     * @param {?} filter
     * @return {?}
     */
    function (filter) {
        this._filters.setFilter(filter);
    };
    /**
     *  add a filter to filters plugins
     */
    /**
     *  add a filter to filters plugins
     * @param {?} filter
     * @return {?}
     */
    AkitaMatDataSource.prototype.setFilter = /**
     *  add a filter to filters plugins
     * @param {?} filter
     * @return {?}
     */
    function (filter) {
        this._filters.setFilter(filter);
    };
    /**
     * Remove a AkitaFilter
     */
    /**
     * Remove a AkitaFilter
     * @param {?} id
     * @return {?}
     */
    AkitaMatDataSource.prototype.removeFilter = /**
     * Remove a AkitaFilter
     * @param {?} id
     * @return {?}
     */
    function (id) {
        this._filters.removeFilter(id);
    };
    /**
     * Clear all filters
     */
    /**
     * Clear all filters
     * @return {?}
     */
    AkitaMatDataSource.prototype.clearFilters = /**
     * Clear all filters
     * @return {?}
     */
    function () {
        this._filters.clearFilters();
    };
    /**
     * Get filter value, return null, if value not available
     */
    /**
     * Get filter value, return null, if value not available
     * @template V
     * @param {?} id
     * @return {?}
     */
    AkitaMatDataSource.prototype.getFilterValue = /**
     * Get filter value, return null, if value not available
     * @template V
     * @param {?} id
     * @return {?}
     */
    function (id) {
        return this._filters.getFilterValue(id);
    };
    /**
     * Set the default sort
     * @param sortColumn the colum name present in your object
     * @param direction string the direction for sorting (asc or desc). Default asc.
     */
    /**
     * Set the default sort
     * @param {?} sortColumn the colum name present in your object
     * @param {?=} direction string the direction for sorting (asc or desc). Default asc.
     * @return {?}
     */
    AkitaMatDataSource.prototype.setDefaultSort = /**
     * Set the default sort
     * @param {?} sortColumn the colum name present in your object
     * @param {?=} direction string the direction for sorting (asc or desc). Default asc.
     * @return {?}
     */
    function (sortColumn, direction) {
        if (direction === void 0) { direction = 'asc'; }
        this._filters.setSortBy({
            sortBy: sortColumn,
            sortByOrder: direction === 'desc' ? Order.DESC : Order.ASC
        });
    };
    /**
     * Select Count filtered results.
     */
    /**
     * Select Count filtered results.
     * @return {?}
     */
    AkitaMatDataSource.prototype.selectCount = /**
     * Select Count filtered results.
     * @return {?}
     */
    function () {
        return this._count$.asObservable();
    };
    /**
     * Select Count filtered results.
     */
    /**
     * Select Count filtered results.
     * @return {?}
     */
    AkitaMatDataSource.prototype.getCount = /**
     * Select Count filtered results.
     * @return {?}
     */
    function () {
        return this._count$.getValue();
    };
    /**
     * Subscribe to changes that should trigger an update to the table's rendered rows. When the
     * changes occur, process the current state of the filter, sort, and pagination along with
     * the provided base data and send it to the table for rendering.
     */
    /**
     * Subscribe to changes that should trigger an update to the table's rendered rows. When the
     * changes occur, process the current state of the filter, sort, and pagination along with
     * the provided base data and send it to the table for rendering.
     * @return {?}
     */
    AkitaMatDataSource.prototype._updateChangeSubscription = /**
     * Subscribe to changes that should trigger an update to the table's rendered rows. When the
     * changes occur, process the current state of the filter, sort, and pagination along with
     * the provided base data and send it to the table for rendering.
     * @return {?}
     */
    function () {
        // Sorting and/or pagination should be watched if MatSort and/or MatPaginator are provided.
        // The events should emit whenever the component emits a change or initializes, or if no
        // component is provided, a stream with just a null event should be provided.
        // The `sortChange` and `pageChange` acts as a signal to the combineLatests below so that the
        // pipeline can progress to the next step. Note that the value from these streams are not used,
        // they purely act as a signal to progress in the pipeline.
        var _this = this;
        // Sorting and/or pagination should be watched if MatSort and/or MatPaginator are provided.
        // The events should emit whenever the component emits a change or initializes, or if no
        // component is provided, a stream with just a null event should be provided.
        // The `sortChange` and `pageChange` acts as a signal to the combineLatests below so that the
        // pipeline can progress to the next step. Note that the value from these streams are not used,
        // they purely act as a signal to progress in the pipeline.
        /** @type {?} */
        var pageChange = this._paginator ?
            (/** @type {?} */ (merge(this._paginator.page, this._internalPageChanges, this._paginator.initialized))) :
            of(null);
        /** @type {?} */
        var paginatedData = combineLatest(this._selectAllByFilter$, pageChange)
            .pipe(map((/**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var _b = tslib_1.__read(_a, 1), data = _b[0];
            return _this._pageData(data);
        })));
        // Watched for paged data changes and send the result to the table to render.
        this._renderChangesSubscription.unsubscribe();
        this._renderChangesSubscription = paginatedData.pipe(takeUntil(this._disconnect)).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) { return _this._renderData.next(data); }));
        this._internalPageChanges.next();
    };
    /**
     * Updates the paginator to reflect the length of the filtered data, and makes sure that the page
     * index does not exceed the paginator's last page. Values are changed in a resolved promise to
     * guard against making property changes within a round of change detection.
     */
    /**
     * Updates the paginator to reflect the length of the filtered data, and makes sure that the page
     * index does not exceed the paginator's last page. Values are changed in a resolved promise to
     * guard against making property changes within a round of change detection.
     * @param {?} filteredDataLength
     * @return {?}
     */
    AkitaMatDataSource.prototype._updatePaginator = /**
     * Updates the paginator to reflect the length of the filtered data, and makes sure that the page
     * index does not exceed the paginator's last page. Values are changed in a resolved promise to
     * guard against making property changes within a round of change detection.
     * @param {?} filteredDataLength
     * @return {?}
     */
    function (filteredDataLength) {
        var _this = this;
        Promise.resolve().then((/**
         * @return {?}
         */
        function () {
            /** @type {?} */
            var paginator = _this.paginator;
            if (!paginator) {
                return;
            }
            paginator.length = filteredDataLength;
            // If the page index is set beyond the page, reduce it to the last page.
            if (paginator.pageIndex > 0) {
                /** @type {?} */
                var lastPageIndex = Math.ceil(paginator.length / paginator.pageSize) - 1 || 0;
                /** @type {?} */
                var newPageIndex = Math.min(paginator.pageIndex, lastPageIndex);
                if (newPageIndex !== paginator.pageIndex) {
                    paginator.pageIndex = newPageIndex;
                    // Since the paginator only emits after user-generated changes,
                    // we need our own stream so we know to should re-render the data.
                    _this._internalPageChanges.next();
                }
            }
        }));
    };
    /**
     * Function used by matTable to subscribe to the data
     */
    /**
     * Function used by matTable to subscribe to the data
     * @return {?}
     */
    AkitaMatDataSource.prototype.connect = /**
     * Function used by matTable to subscribe to the data
     * @return {?}
     */
    function () {
        return this._renderData;
    };
    /**
     * Used by the MatTable. Called when it is destroyed. No-op.
     * @docs-private
     */
    /**
     * Used by the MatTable. Called when it is destroyed. No-op.
     * \@docs-private
     * @return {?}
     */
    AkitaMatDataSource.prototype.disconnect = /**
     * Used by the MatTable. Called when it is destroyed. No-op.
     * \@docs-private
     * @return {?}
     */
    function () {
        if (!this._hasCustomFilters) {
            this._filters.clearFilters();
            this._filters.destroy();
        }
        this._disconnect.next();
        this._disconnect.complete();
    };
    return AkitaMatDataSource;
}(DataSource));
/**
 * @template S, E
 */
export { AkitaMatDataSource };
if (false) {
    /**
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._dataQuery;
    /**
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._filters;
    /**
     * if set a custom filter plugins, do not delete all in disconnect() *
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._hasCustomFilters;
    /**
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._paginator;
    /**
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._sort;
    /**
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._selectAllByFilter$;
    /**
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._count$;
    /**
     * Used to react to internal changes of the paginator that are made by the data source itself.
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._internalPageChanges;
    /**
     * Stream emitting render data to the table (depends on ordered data changes).
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._renderData;
    /**
     * Used to react to internal changes of the paginator that are made by the data source itself.
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._disconnect;
    /**
     * Subscription to the changes that should trigger an update to the table's rendered rows, such
     * as filtering, sorting, pagination, or base data changes.
     * @type {?}
     */
    AkitaMatDataSource.prototype._renderChangesSubscription;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWtpdGEtbWF0LWRhdGEtc291cmNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYWtpdGEtZmlsdGVycy1wbHVnaW4vIiwic291cmNlcyI6WyJsaWIvYm9udXMvYWtpdGEtbWF0LWRhdGEtc291cmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQzlDLE9BQU8sRUFBQyxlQUFlLEVBQUUsYUFBYSxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUNsRyxPQUFPLEVBQWlDLEtBQUssRUFBYyxNQUFNLGlCQUFpQixDQUFDO0FBRW5GLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLHlCQUF5QixDQUFDO0FBQzNELE9BQU8sRUFBQyxHQUFHLEVBQUUsU0FBUyxFQUFNLE1BQU0sZ0JBQWdCLENBQUM7Ozs7QUFJbkQ7Ozs7SUFBMkYsOENBQWE7SUFLdEc7Ozs7OztPQU1HO0lBQ0gsNEJBQVksS0FBMEMsRUFBRSxZQUF1QztRQUEvRixZQUNFLGlCQUFPLFNBV1I7UUE4RU8sZ0JBQVUsR0FBaUIsSUFBSSxDQUFDO1FBQ2hDLFdBQUssR0FBWSxJQUFJLENBQUM7Ozs7UUFLYiwwQkFBb0IsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDOzs7O1FBRTNDLGlCQUFXLEdBQUcsSUFBSSxlQUFlLENBQU0sRUFBRSxDQUFDLENBQUM7Ozs7UUFFM0MsaUJBQVcsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDOzs7OztRQVFuRCxnQ0FBMEIsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDO1FBMUc5QyxLQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQztRQUV4QixLQUFJLENBQUMsUUFBUSxHQUFHLFlBQVksQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJLGtCQUFrQixDQUFPLEtBQUssQ0FBQyxDQUFDO1FBQ2xGLEtB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QVMsQ0FBQyxTQUFTLEdBQUcsWUFBWSxDQUFDO29CQUVuQywrREFBK0Q7b0JBQy9ELGtFQUFrRTtvQkFDbEUsS0FBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksRUFBRSxDQUFDO2lCQUNsQzthQUNGO1FBQ0gsQ0FBQyxFQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7O09BRUc7Ozs7O0lBQ0gsb0NBQU87Ozs7SUFBUDtRQUNFLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMxQixDQUFDO0lBR0Q7OztPQUdHOzs7Ozs7SUFDSCx1Q0FBVTs7Ozs7SUFBVjtRQUNFLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUU7WUFDM0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUM3QixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ3pCO1FBQ0QsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzlCLENBQUM7SUFDSCx5QkFBQztBQUFELENBQUMsQUE3UkQsQ0FBMkYsVUFBVSxHQTZScEc7Ozs7Ozs7Ozs7SUEzTEMsd0NBQW1DOzs7OztJQUNuQyxzQ0FBb0Q7Ozs7OztJQUVwRCwrQ0FBbUM7Ozs7O0lBQ25DLHdDQUF3Qzs7Ozs7SUFDeEMsbUNBQThCOzs7OztJQUU5QixpREFBNkM7Ozs7O0lBQzdDLHFDQUF5Qzs7Ozs7O0lBRXpDLGtEQUE0RDs7Ozs7O0lBRTVELHlDQUE0RDs7Ozs7O0lBRTVELHlDQUFtRDs7Ozs7O0lBUW5ELHdEQUFnRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RGF0YVNvdXJjZX0gZnJvbSAnQGFuZ3VsYXIvY2RrL3RhYmxlJztcbmltcG9ydCB7QmVoYXZpb3JTdWJqZWN0LCBjb21iaW5lTGF0ZXN0LCBtZXJnZSwgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QsIFN1YnNjcmlwdGlvbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge0VudGl0eVN0YXRlLCBnZXRFbnRpdHlUeXBlLCBJRCwgT3JkZXIsIFF1ZXJ5RW50aXR5fSBmcm9tICdAZGF0b3JhbWEvYWtpdGEnO1xuaW1wb3J0IHtBa2l0YUZpbHRlcn0gZnJvbSAnLi4vYWtpdGEtZmlsdGVycy1zdG9yZSc7XG5pbXBvcnQge0FraXRhRmlsdGVyc1BsdWdpbn0gZnJvbSAnLi4vYWtpdGEtZmlsdGVycy1wbHVnaW4nO1xuaW1wb3J0IHttYXAsIHRha2VVbnRpbCwgdGFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge01hdFNvcnQsIFNvcnR9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL3NvcnQnO1xuaW1wb3J0IHsgTWF0UGFnaW5hdG9yLCBQYWdlRXZlbnQgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9wYWdpbmF0b3InO1xuXG5leHBvcnQgY2xhc3MgQWtpdGFNYXREYXRhU291cmNlPFMgZXh0ZW5kcyBFbnRpdHlTdGF0ZSA9IGFueSwgRSA9IGdldEVudGl0eVR5cGU8Uz4+IGV4dGVuZHMgRGF0YVNvdXJjZTxFPiB7XG5cblxuXG5cbiAgLyoqXG4gICAqIERhdGEgc291cmNlIHRvIHVzZSBhbiBBa2l0YSBFbnRpdHlTdG9yZSB3aXRoIGEgTWF0ZXJpYWwgdGFibGVcbiAgICogQHNlZSA6IGh0dHBzOi8vbWF0ZXJpYWwuYW5ndWxhci5pby9jb21wb25lbnRzL3RhYmxlL292ZXJ2aWV3XG4gICAqXG4gICAqIEBwYXJhbSBxdWVyeSBzdHJpbmcgOiBbTWFuZGF0b3J5XSB0aGUgYWtpdGEgUXVlcnkgRW50aXR5LCB5b3Ugd2FuIHRvIHVzZSB0byB0aGlzIGRhdGEgc291cmNlLlxuICAgKiBAcGFyYW0gYWtpdGFGaWx0ZXJzIHN0cmluZyBbT3B0aW9uYWxdIElmIHlvdSB3YW50IHRvIHByb3ZpZGUgYW4gQWtpdGFGaWx0ZXJzIHRoYXQgeW91IHVzZSBleHRlcm5hbGx5LiBFbHNlIGl0IHdpbGwgY3JlYXRlIGEgbmV3IG9uZS5cbiAgICovXG4gIGNvbnN0cnVjdG9yKHF1ZXJ5OiBRdWVyeUVudGl0eTxnZXRFbnRpdHlUeXBlPFM+PiB8IGFueSwgYWtpdGFGaWx0ZXJzPzogQWtpdGFGaWx0ZXJzUGx1Z2luPFMsIEU+KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9kYXRhUXVlcnkgPSBxdWVyeTtcblxuICAgIHRoaXMuX2ZpbHRlcnMgPSBha2l0YUZpbHRlcnMgPyBha2l0YUZpbHRlcnMgOiBuZXcgQWtpdGFGaWx0ZXJzUGx1Z2luPFMsIEU+KHF1ZXJ5KTtcbiAgICB0aGlzLl9oYXNDdXN0b21GaWx0ZXJzID0gISFha2l0YUZpbHRlcnM7XG4gICAgdGhpcy5fY291bnQkID0gbmV3IEJlaGF2aW9yU3ViamVjdCgwKTtcblxuICAgIGxldCBjb3VudCA9IDA7XG4gICAgLy8gQHRzLWlnbm9yZSBpZ25vcmUsIGFzIHdpdGhvdXQgb3B0aW9ucywgd2Ugd2lsbCBhbGx3YXlzIGhhdmUgYW4gQXJyYXkuXG4gICAgdGhpcy5fc2VsZWN0QWxsQnlGaWx0ZXIkID0gdGhpcy5fZmlsdGVycy5zZWxlY3RBbGxCeUZpbHRlcnMoKTtcbiAgICB0aGlzLl91cGRhdGVDaGFuZ2VTdWJzY3JpcHRpb24oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0gc2VhcmNoUXVlcnkgdGVoIHN0cmluZyB1c2UgdG8gc2VhcmNoXG4gICAqL1xuICBzZXQgZmlsdGVyKHNlYXJjaFF1ZXJ5OiBzdHJpbmcpIHtcbiAgICB0aGlzLnNlYXJjaCA9IHNlYXJjaFF1ZXJ5O1xuICB9XG5cbiAgLyoqXG4gICAqIGZpbHRlciBhbGwgdGhlIGxpc3QgYnkgYSBzZWFyY2ggdGVybS5cbiAgICpcbiAgICogdXNlIGxpa2UgYSBwcm9wZXJ0eSA6XG4gICAqIGFraXRhTWF0RGF0YVNvdXJjZUluc3RhbmNlLnNlYXJjaCA9ICd0ZXJtJztcbiAgICogQHBhcmFtIHNlYXJjaFF1ZXJ5IHRoZSBzdHJpbmcgdXNlIHRvIHNlYXJjaFxuICAgKi9cbiAgc2V0IHNlYXJjaChzZWFyY2hRdWVyeTogc3RyaW5nKSB7XG4gICAgaWYgKHNlYXJjaFF1ZXJ5ID09PSAnJykge1xuICAgICAgdGhpcy5fZmlsdGVycy5yZW1vdmVGaWx0ZXIoJ3NlYXJjaCcpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9maWx0ZXJzLnNldEZpbHRlcih7aWQ6ICdzZWFyY2gnLCB2YWx1ZTogc2VhcmNoUXVlcnl9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW5zdGFuY2Ugb2YgdGhlIE1hdFNvcnQgZGlyZWN0aXZlIHVzZWQgYnkgdGhlIHRhYmxlIHRvIGNvbnRyb2wgaXRzIHNvcnRpbmcuIFNvcnQgY2hhbmdlc1xuICAgKiBlbWl0dGVkIGJ5IHRoZSBNYXRTb3J0IHdpbGwgdHJpZ2dlciBhbiB1cGRhdGUgdG8gdGhlIHRhYmxlJ3MgcmVuZGVyZWQgZGF0YS5cbiAgICovXG4gIHNldCBzb3J0KHNvcnQ6IE1hdFNvcnQpIHtcbiAgICB0aGlzLl9zb3J0ID0gc29ydDtcbiAgICBzb3J0LnNvcnRDaGFuZ2UucGlwZSh0YWtlVW50aWwodGhpcy5fZGlzY29ubmVjdCkpLnN1YnNjcmliZSgoc29ydFZhbHVlOiBTb3J0KSA9PiB7XG4gICAgICB0aGlzLl9maWx0ZXJzLnNldFNvcnRCeSh7XG4gICAgICAgIHNvcnRCeTogc29ydFZhbHVlLmFjdGl2ZSBhcyBrZXlvZiBFLFxuICAgICAgICBzb3J0QnlPcmRlcjogc29ydFZhbHVlLmRpcmVjdGlvbiA9PT0gJ2Rlc2MnID8gT3JkZXIuREVTQyA6IE9yZGVyLkFTQ1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBzb3J0LmluaXRpYWxpemVkLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICB0aGlzLnNldERlZmF1bHRTb3J0KHNvcnQuYWN0aXZlIGFzIGtleW9mIEUsIHNvcnQuZGlyZWN0aW9uID09PSAnZGVzYycgPyBPcmRlci5ERVNDIDogT3JkZXIuQVNDKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnN0YW5jZSBvZiB0aGUgTWF0UGFnaW5hdG9yIGNvbXBvbmVudCB1c2VkIGJ5IHRoZSB0YWJsZSB0byBjb250cm9sIHdoYXQgcGFnZSBvZiB0aGUgZGF0YSBpc1xuICAgKiBkaXNwbGF5ZWQuIFBhZ2UgY2hhbmdlcyBlbWl0dGVkIGJ5IHRoZSBNYXRQYWdpbmF0b3Igd2lsbCB0cmlnZ2VyIGFuIHVwZGF0ZSB0byB0aGVcbiAgICogdGFibGUncyByZW5kZXJlZCBkYXRhLlxuICAgKlxuICAgKiBOb3RlIHRoYXQgdGhlIGRhdGEgc291cmNlIHVzZXMgdGhlIHBhZ2luYXRvcidzIHByb3BlcnRpZXMgdG8gY2FsY3VsYXRlIHdoaWNoIHBhZ2Ugb2YgZGF0YVxuICAgKiBzaG91bGQgYmUgZGlzcGxheWVkLiBJZiB0aGUgcGFnaW5hdG9yIHJlY2VpdmVzIGl0cyBwcm9wZXJ0aWVzIGFzIHRlbXBsYXRlIGlucHV0cyxcbiAgICogZS5nLiBgW3BhZ2VMZW5ndGhdPTEwMGAgb3IgYFtwYWdlSW5kZXhdPTFgLCB0aGVuIGJlIHN1cmUgdGhhdCB0aGUgcGFnaW5hdG9yJ3MgdmlldyBoYXMgYmVlblxuICAgKiBpbml0aWFsaXplZCBiZWZvcmUgYXNzaWduaW5nIGl0IHRvIHRoaXMgZGF0YSBzb3VyY2UuXG4gICAqL1xuICBnZXQgcGFnaW5hdG9yKCk6IE1hdFBhZ2luYXRvciB7XG4gICAgcmV0dXJuIHRoaXMuX3BhZ2luYXRvcjtcbiAgfVxuXG4gIHNldCBwYWdpbmF0b3IocGFnaW5hdG9yOiBNYXRQYWdpbmF0b3IpIHtcbiAgICB0aGlzLl9wYWdpbmF0b3IgPSBwYWdpbmF0b3I7XG4gICAgdGhpcy5fdXBkYXRlQ2hhbmdlU3Vic2NyaXB0aW9uKCk7XG4gIH1cblxuICAvKipcbiAgICogQGRlcHJlY2F0ZWQgdXNlIGdldCBha2l0YUZpbHRlcnNQbHVnaW5cbiAgICovXG4gIGdldCBBa2l0YUZpbHRlcnMoKTogQWtpdGFGaWx0ZXJzUGx1Z2luPFMsIEUsIGFueT4ge1xuICAgIHJldHVybiB0aGlzLl9maWx0ZXJzO1xuICB9XG4gIC8qKlxuICAgKiBBY2Nlc3MgdG8gQWtpdGFGaWx0ZXJzUGx1Z2lucywgdXNlZnVsbCB0byBpbnRlcmFjdCB3aXRoIGFsbCBmaWx0ZXJzXG4gICAqL1xuICBnZXQgYWtpdGFGaWx0ZXJzUGx1Z0luKCk6IEFraXRhRmlsdGVyc1BsdWdpbjxTLCBFPiB7XG4gICAgcmV0dXJuIHRoaXMuX2ZpbHRlcnM7XG4gIH1cblxuICBwcml2YXRlIF9kYXRhUXVlcnk6IFF1ZXJ5RW50aXR5PEU+O1xuICBwcml2YXRlIHJlYWRvbmx5IF9maWx0ZXJzOiBBa2l0YUZpbHRlcnNQbHVnaW48UywgRT47XG4gIC8qKiBpZiBzZXQgYSBjdXN0b20gZmlsdGVyIHBsdWdpbnMsIGRvIG5vdCBkZWxldGUgYWxsIGluIGRpc2Nvbm5lY3QoKSAqKi9cbiAgcHJpdmF0ZSBfaGFzQ3VzdG9tRmlsdGVyczogYm9vbGVhbjtcbiAgcHJpdmF0ZSBfcGFnaW5hdG9yOiBNYXRQYWdpbmF0b3IgPSBudWxsO1xuICBwcml2YXRlIF9zb3J0OiBNYXRTb3J0ID0gbnVsbDtcblxuICBwcml2YXRlIF9zZWxlY3RBbGxCeUZpbHRlciQ6IE9ic2VydmFibGU8RVtdPjtcbiAgcHJpdmF0ZSBfY291bnQkOiBCZWhhdmlvclN1YmplY3Q8bnVtYmVyPjtcbiAgLyoqIFVzZWQgdG8gcmVhY3QgdG8gaW50ZXJuYWwgY2hhbmdlcyBvZiB0aGUgcGFnaW5hdG9yIHRoYXQgYXJlIG1hZGUgYnkgdGhlIGRhdGEgc291cmNlIGl0c2VsZi4gKi9cbiAgcHJpdmF0ZSByZWFkb25seSBfaW50ZXJuYWxQYWdlQ2hhbmdlcyA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gIC8qKiBTdHJlYW0gZW1pdHRpbmcgcmVuZGVyIGRhdGEgdG8gdGhlIHRhYmxlIChkZXBlbmRzIG9uIG9yZGVyZWQgZGF0YSBjaGFuZ2VzKS4gKi9cbiAgcHJpdmF0ZSByZWFkb25seSBfcmVuZGVyRGF0YSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8RVtdPihbXSk7XG4gIC8qKiBVc2VkIHRvIHJlYWN0IHRvIGludGVybmFsIGNoYW5nZXMgb2YgdGhlIHBhZ2luYXRvciB0aGF0IGFyZSBtYWRlIGJ5IHRoZSBkYXRhIHNvdXJjZSBpdHNlbGYuICovXG4gIHByaXZhdGUgcmVhZG9ubHkgX2Rpc2Nvbm5lY3QgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG5cblxuICAvKipcbiAgICogU3Vic2NyaXB0aW9uIHRvIHRoZSBjaGFuZ2VzIHRoYXQgc2hvdWxkIHRyaWdnZXIgYW4gdXBkYXRlIHRvIHRoZSB0YWJsZSdzIHJlbmRlcmVkIHJvd3MsIHN1Y2hcbiAgICogYXMgZmlsdGVyaW5nLCBzb3J0aW5nLCBwYWdpbmF0aW9uLCBvciBiYXNlIGRhdGEgY2hhbmdlcy5cbiAgICovXG4gIF9yZW5kZXJDaGFuZ2VzU3Vic2NyaXB0aW9uID0gU3Vic2NyaXB0aW9uLkVNUFRZO1xuXG4gIHByaXZhdGUgX3VwZGF0ZUNvdW50KHZhbHVlOiBFW10pIHtcbiAgICBjb25zdCBjb3VudCA9IHZhbHVlLmxlbmd0aCA/IHZhbHVlLmxlbmd0aCA6IDA7XG4gICAgaWYgKGNvdW50ICE9PSB0aGlzLl9jb3VudCQuZ2V0VmFsdWUoKSkge1xuICAgICAgdGhpcy5fY291bnQkLm5leHQoY291bnQpO1xuXG4gICAgICB0aGlzLl91cGRhdGVQYWdpbmF0b3IoY291bnQpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBQYWdpbmF0ZSB0aGUgZGF0YSAoY2xpZW50LXNpZGUpLiBJZiB5b3UncmUgdXNpbmcgc2VydmVyLXNpZGUgcGFnaW5hdGlvbixcbiAgICogdGhpcyB3b3VsZCBiZSByZXBsYWNlZCBieSByZXF1ZXN0aW5nIHRoZSBhcHByb3ByaWF0ZSBkYXRhIGZyb20gdGhlIHNlcnZlci5cbiAgICovXG4gIHByaXZhdGUgX3BhZ2VEYXRhKGRhdGE6IEVbXSkge1xuICAgIHRoaXMuX3VwZGF0ZUNvdW50KGRhdGEpO1xuICAgIGlmICghdGhpcy5wYWdpbmF0b3IpIHsgcmV0dXJuIGRhdGE7IH1cblxuICAgIGNvbnN0IHN0YXJ0SW5kZXggPSB0aGlzLnBhZ2luYXRvci5wYWdlSW5kZXggKiB0aGlzLnBhZ2luYXRvci5wYWdlU2l6ZTtcbiAgICByZXR1cm4gZGF0YS5zbGljZShzdGFydEluZGV4LCBzdGFydEluZGV4ICsgdGhpcy5wYWdpbmF0b3IucGFnZVNpemUpO1xuICB9XG5cbiAgLyoqXG4gICAqICBhZGQgYSBmaWx0ZXIgdG8gZmlsdGVycyBwbHVnaW5zXG4gICAqL1xuICBhZGRGaWx0ZXIoZmlsdGVyOiBQYXJ0aWFsPEFraXRhRmlsdGVyPFM+Pik6IHZvaWQge1xuICAgIHRoaXMuX2ZpbHRlcnMuc2V0RmlsdGVyKGZpbHRlcik7XG4gIH1cblxuICAvKipcbiAgICogIGFkZCBhIGZpbHRlciB0byBmaWx0ZXJzIHBsdWdpbnNcbiAgICovXG4gIHNldEZpbHRlcihmaWx0ZXI6IFBhcnRpYWw8QWtpdGFGaWx0ZXI8Uz4+KTogdm9pZCB7XG4gICAgdGhpcy5fZmlsdGVycy5zZXRGaWx0ZXIoZmlsdGVyKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgYSBBa2l0YUZpbHRlclxuICAgKi9cbiAgcmVtb3ZlRmlsdGVyKGlkOiBJRCk6IHZvaWQge1xuICAgIHRoaXMuX2ZpbHRlcnMucmVtb3ZlRmlsdGVyKGlkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciBhbGwgZmlsdGVyc1xuICAgKi9cbiAgY2xlYXJGaWx0ZXJzKCk6IHZvaWQge1xuICAgIHRoaXMuX2ZpbHRlcnMuY2xlYXJGaWx0ZXJzKCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGZpbHRlciB2YWx1ZSwgcmV0dXJuIG51bGwsIGlmIHZhbHVlIG5vdCBhdmFpbGFibGVcbiAgICovXG4gIGdldEZpbHRlclZhbHVlPFYgPSBFPihpZDogc3RyaW5nKTogViB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLl9maWx0ZXJzLmdldEZpbHRlclZhbHVlKGlkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGRlZmF1bHQgc29ydFxuICAgKiBAcGFyYW0gc29ydENvbHVtbiB0aGUgY29sdW0gbmFtZSBwcmVzZW50IGluIHlvdXIgb2JqZWN0XG4gICAqIEBwYXJhbSBkaXJlY3Rpb24gc3RyaW5nIHRoZSBkaXJlY3Rpb24gZm9yIHNvcnRpbmcgKGFzYyBvciBkZXNjKS4gRGVmYXVsdCBhc2MuXG4gICAqL1xuICBwdWJsaWMgc2V0RGVmYXVsdFNvcnQoXG4gICAgc29ydENvbHVtbjoga2V5b2YgRSxcbiAgICBkaXJlY3Rpb246ICdhc2MnIHwgJ2Rlc2MnID0gJ2FzYydcbiAgKSB7XG4gICAgdGhpcy5fZmlsdGVycy5zZXRTb3J0Qnkoe1xuICAgICAgc29ydEJ5OiBzb3J0Q29sdW1uLFxuICAgICAgc29ydEJ5T3JkZXI6IGRpcmVjdGlvbiA9PT0gJ2Rlc2MnID8gT3JkZXIuREVTQyA6IE9yZGVyLkFTQ1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdCBDb3VudCBmaWx0ZXJlZCByZXN1bHRzLlxuICAgKi9cbiAgc2VsZWN0Q291bnQoKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICByZXR1cm4gdGhpcy5fY291bnQkLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdCBDb3VudCBmaWx0ZXJlZCByZXN1bHRzLlxuICAgKi9cbiAgZ2V0Q291bnQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fY291bnQkLmdldFZhbHVlKCk7XG4gIH1cblxuICAvKipcbiAgICogU3Vic2NyaWJlIHRvIGNoYW5nZXMgdGhhdCBzaG91bGQgdHJpZ2dlciBhbiB1cGRhdGUgdG8gdGhlIHRhYmxlJ3MgcmVuZGVyZWQgcm93cy4gV2hlbiB0aGVcbiAgICogY2hhbmdlcyBvY2N1ciwgcHJvY2VzcyB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgZmlsdGVyLCBzb3J0LCBhbmQgcGFnaW5hdGlvbiBhbG9uZyB3aXRoXG4gICAqIHRoZSBwcm92aWRlZCBiYXNlIGRhdGEgYW5kIHNlbmQgaXQgdG8gdGhlIHRhYmxlIGZvciByZW5kZXJpbmcuXG4gICAqL1xuICBfdXBkYXRlQ2hhbmdlU3Vic2NyaXB0aW9uKCkge1xuICAgIC8vIFNvcnRpbmcgYW5kL29yIHBhZ2luYXRpb24gc2hvdWxkIGJlIHdhdGNoZWQgaWYgTWF0U29ydCBhbmQvb3IgTWF0UGFnaW5hdG9yIGFyZSBwcm92aWRlZC5cbiAgICAvLyBUaGUgZXZlbnRzIHNob3VsZCBlbWl0IHdoZW5ldmVyIHRoZSBjb21wb25lbnQgZW1pdHMgYSBjaGFuZ2Ugb3IgaW5pdGlhbGl6ZXMsIG9yIGlmIG5vXG4gICAgLy8gY29tcG9uZW50IGlzIHByb3ZpZGVkLCBhIHN0cmVhbSB3aXRoIGp1c3QgYSBudWxsIGV2ZW50IHNob3VsZCBiZSBwcm92aWRlZC5cbiAgICAvLyBUaGUgYHNvcnRDaGFuZ2VgIGFuZCBgcGFnZUNoYW5nZWAgYWN0cyBhcyBhIHNpZ25hbCB0byB0aGUgY29tYmluZUxhdGVzdHMgYmVsb3cgc28gdGhhdCB0aGVcbiAgICAvLyBwaXBlbGluZSBjYW4gcHJvZ3Jlc3MgdG8gdGhlIG5leHQgc3RlcC4gTm90ZSB0aGF0IHRoZSB2YWx1ZSBmcm9tIHRoZXNlIHN0cmVhbXMgYXJlIG5vdCB1c2VkLFxuICAgIC8vIHRoZXkgcHVyZWx5IGFjdCBhcyBhIHNpZ25hbCB0byBwcm9ncmVzcyBpbiB0aGUgcGlwZWxpbmUuXG5cbiAgICBjb25zdCBwYWdlQ2hhbmdlOiBPYnNlcnZhYmxlPFBhZ2VFdmVudHxudWxsfHZvaWQ+ID0gdGhpcy5fcGFnaW5hdG9yID9cbiAgICAgIG1lcmdlKFxuICAgICAgICB0aGlzLl9wYWdpbmF0b3IucGFnZSxcbiAgICAgICAgdGhpcy5faW50ZXJuYWxQYWdlQ2hhbmdlcyxcbiAgICAgICAgdGhpcy5fcGFnaW5hdG9yLmluaXRpYWxpemVkXG4gICAgICApIGFzIE9ic2VydmFibGU8UGFnZUV2ZW50fHZvaWQ+IDpcbiAgICAgIG9mKG51bGwpO1xuXG4gICAgY29uc3QgcGFnaW5hdGVkRGF0YSA9IGNvbWJpbmVMYXRlc3QodGhpcy5fc2VsZWN0QWxsQnlGaWx0ZXIkLCBwYWdlQ2hhbmdlKVxuICAgICAgLnBpcGUobWFwKChbZGF0YV0pID0+IHRoaXMuX3BhZ2VEYXRhKGRhdGEpKSk7XG4gICAgLy8gV2F0Y2hlZCBmb3IgcGFnZWQgZGF0YSBjaGFuZ2VzIGFuZCBzZW5kIHRoZSByZXN1bHQgdG8gdGhlIHRhYmxlIHRvIHJlbmRlci5cbiAgICB0aGlzLl9yZW5kZXJDaGFuZ2VzU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgdGhpcy5fcmVuZGVyQ2hhbmdlc1N1YnNjcmlwdGlvbiA9IHBhZ2luYXRlZERhdGEucGlwZSh0YWtlVW50aWwodGhpcy5fZGlzY29ubmVjdCkpLnN1YnNjcmliZShkYXRhID0+IHRoaXMuX3JlbmRlckRhdGEubmV4dChkYXRhKSk7XG4gICAgdGhpcy5faW50ZXJuYWxQYWdlQ2hhbmdlcy5uZXh0KCk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlcyB0aGUgcGFnaW5hdG9yIHRvIHJlZmxlY3QgdGhlIGxlbmd0aCBvZiB0aGUgZmlsdGVyZWQgZGF0YSwgYW5kIG1ha2VzIHN1cmUgdGhhdCB0aGUgcGFnZVxuICAgKiBpbmRleCBkb2VzIG5vdCBleGNlZWQgdGhlIHBhZ2luYXRvcidzIGxhc3QgcGFnZS4gVmFsdWVzIGFyZSBjaGFuZ2VkIGluIGEgcmVzb2x2ZWQgcHJvbWlzZSB0b1xuICAgKiBndWFyZCBhZ2FpbnN0IG1ha2luZyBwcm9wZXJ0eSBjaGFuZ2VzIHdpdGhpbiBhIHJvdW5kIG9mIGNoYW5nZSBkZXRlY3Rpb24uXG4gICAqL1xuICBfdXBkYXRlUGFnaW5hdG9yKGZpbHRlcmVkRGF0YUxlbmd0aDogbnVtYmVyKSB7XG4gICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiB7XG4gICAgICBjb25zdCBwYWdpbmF0b3IgPSB0aGlzLnBhZ2luYXRvcjtcblxuICAgICAgaWYgKCFwYWdpbmF0b3IpIHsgcmV0dXJuOyB9XG5cbiAgICAgIHBhZ2luYXRvci5sZW5ndGggPSBmaWx0ZXJlZERhdGFMZW5ndGg7XG5cbiAgICAgIC8vIElmIHRoZSBwYWdlIGluZGV4IGlzIHNldCBiZXlvbmQgdGhlIHBhZ2UsIHJlZHVjZSBpdCB0byB0aGUgbGFzdCBwYWdlLlxuICAgICAgaWYgKHBhZ2luYXRvci5wYWdlSW5kZXggPiAwKSB7XG4gICAgICAgIGNvbnN0IGxhc3RQYWdlSW5kZXggPSBNYXRoLmNlaWwocGFnaW5hdG9yLmxlbmd0aCAvIHBhZ2luYXRvci5wYWdlU2l6ZSkgLSAxIHx8IDA7XG4gICAgICAgIGNvbnN0IG5ld1BhZ2VJbmRleCA9IE1hdGgubWluKHBhZ2luYXRvci5wYWdlSW5kZXgsIGxhc3RQYWdlSW5kZXgpO1xuXG4gICAgICAgIGlmIChuZXdQYWdlSW5kZXggIT09IHBhZ2luYXRvci5wYWdlSW5kZXgpIHtcbiAgICAgICAgICBwYWdpbmF0b3IucGFnZUluZGV4ID0gbmV3UGFnZUluZGV4O1xuXG4gICAgICAgICAgLy8gU2luY2UgdGhlIHBhZ2luYXRvciBvbmx5IGVtaXRzIGFmdGVyIHVzZXItZ2VuZXJhdGVkIGNoYW5nZXMsXG4gICAgICAgICAgLy8gd2UgbmVlZCBvdXIgb3duIHN0cmVhbSBzbyB3ZSBrbm93IHRvIHNob3VsZCByZS1yZW5kZXIgdGhlIGRhdGEuXG4gICAgICAgICAgdGhpcy5faW50ZXJuYWxQYWdlQ2hhbmdlcy5uZXh0KCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGdW5jdGlvbiB1c2VkIGJ5IG1hdFRhYmxlIHRvIHN1YnNjcmliZSB0byB0aGUgZGF0YVxuICAgKi9cbiAgY29ubmVjdCgpOiBPYnNlcnZhYmxlPEVbXT4ge1xuICAgIHJldHVybiB0aGlzLl9yZW5kZXJEYXRhO1xuICB9XG5cblxuICAvKipcbiAgICogVXNlZCBieSB0aGUgTWF0VGFibGUuIENhbGxlZCB3aGVuIGl0IGlzIGRlc3Ryb3llZC4gTm8tb3AuXG4gICAqIEBkb2NzLXByaXZhdGVcbiAgICovXG4gIGRpc2Nvbm5lY3QoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLl9oYXNDdXN0b21GaWx0ZXJzKSB7XG4gICAgICB0aGlzLl9maWx0ZXJzLmNsZWFyRmlsdGVycygpO1xuICAgICAgdGhpcy5fZmlsdGVycy5kZXN0cm95KCk7XG4gICAgfVxuICAgIHRoaXMuX2Rpc2Nvbm5lY3QubmV4dCgpO1xuICAgIHRoaXMuX2Rpc2Nvbm5lY3QuY29tcGxldGUoKTtcbiAgfVxufVxuIl19