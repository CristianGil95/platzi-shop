/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { AkitaFiltersStore, createFilter } from './akita-filters-store';
import { AkitaFiltersQuery } from './akita-filters-query';
import { combineLatest, isObservable, merge } from 'rxjs';
import { map } from 'rxjs/operators';
import { compareValues, EntityCollectionPlugin, isFunction, isUndefined } from '@datorama/akita';
/**
 * @record
 * @template S
 */
export function FiltersParams() { }
if (false) {
    /** @type {?|undefined} */
    FiltersParams.prototype.filtersStoreName;
    /** @type {?|undefined} */
    FiltersParams.prototype.entityIds;
    /* Skipping unhandled member: [key: string]: any;*/
}
/**
 * @record
 */
function NormalizedFilterOptions() { }
if (false) {
    /** @type {?|undefined} */
    NormalizedFilterOptions.prototype.withSort;
    /** @type {?|undefined} */
    NormalizedFilterOptions.prototype.asQueryParams;
    /** @type {?|undefined} */
    NormalizedFilterOptions.prototype.sortByKey;
    /** @type {?|undefined} */
    NormalizedFilterOptions.prototype.sortByOrderKey;
}
/**
 * @template S, E, I, P
 */
export class AkitaFiltersPlugin extends EntityCollectionPlugin {
    /**
     * @param {?} query
     * @param {?=} params
     */
    constructor(query, params = {}) {
        super(query, params.entityIds);
        this.query = query;
        this.params = params;
        this._server = false;
        this.params = Object.assign({ filtersStoreName: this.getStore().storeName + 'Filters' }, params);
        this._filtersStore = new AkitaFiltersStore(this.params.filtersStoreName);
        this._filtersQuery = new AkitaFiltersQuery(this._filtersStore);
        this._selectFilters$ = this.filtersQuery.selectAll({ sortBy: 'order' });
        this._selectFiltersAll$ = this.filtersQuery.selectAll({ sortBy: 'order', filterBy: (/**
             * @param {?} filter
             * @return {?}
             */
            filter => !filter.hide) });
        this._selectSortBy$ = this.filtersQuery.select((/**
         * @param {?} state
         * @return {?}
         */
        state => state && state.sort ? state.sort : null));
    }
    /**
     * @return {?}
     */
    get filtersStore() {
        return this._filtersStore;
    }
    /**
     * @return {?}
     */
    get filtersQuery() {
        return this._filtersQuery;
    }
    /**
     *  Add support of filters from server. Provide a function that will be call each time a filter changes
     *
     *  new AkitaFilterPlugins(query).withServer((filters) => {
     *      return this.api.getData(filters);
     *  });
     *
     *  Return false to not add in store. if you want to manage the store in your own.
     * @param {?} onChangeFilter
     * @param {?=} options
     * @return {?}
     */
    withServer(onChangeFilter, options = {}) {
        this._server = true;
        // Change default select filters to remove server filters, if you use selectAllByFilters();
        this._selectFilters$ = this._filtersQuery.selectAll({ sortBy: 'order', filterBy: (/**
             * @param {?} filter
             * @return {?}
             */
            filter => !filter.server) });
        /** @type {?} */
        const listObservable = [];
        listObservable.push(this._filtersQuery.selectAll({ sortBy: 'order', filterBy: (/**
             * @param {?} filter
             * @return {?}
             */
            filter => filter.server) }));
        if (options.withSort) {
            listObservable.push(this.selectSortBy());
        }
        merge(listObservable).subscribe((/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const returnOnChange = onChangeFilter(this.getNormalizedFilters(options));
            if (returnOnChange !== false && isObservable(returnOnChange)) {
                returnOnChange.subscribe((/**
                 * @param {?} newValue
                 * @return {?}
                 */
                (newValue) => {
                    this.getStore().set(newValue);
                }));
            }
        }));
        return this;
    }
    /**
     * Return true, if server is configured *
     * @return {?}
     */
    hasServer() {
        return this._server;
    }
    /**
     *  Select all filters
     *
     *  Note: Only all filters not hided (with hide=true), will not be displayed. If you want it, call directly to:
     * `this.filtersQuery.selectAll()`
     *
     *
     * @return {?}
     */
    selectFilters() {
        return this._selectFiltersAll$;
    }
    /**
     * Get all the current snapshot filters
     *
     *  Note: filters with hide=true, will not be displayed. If you want it, call directly to:
     * `this.filtersQuery.getAll()`
     * @return {?}
     */
    getFilters() {
        return this._filtersQuery.getAll({ filterBy: (/**
             * @param {?} filter
             * @return {?}
             */
            filter => !filter.hide) });
    }
    /**
     * Get all the current snapshot server filters (only if server is available else return default not hidden filters)
     *
     *  Note: filters with server=false, will not be displayed. If you want it, call directly to:
     * `this.filtersQuery.getAll()`
     * @return {?}
     */
    getServerFilters() {
        return this._server ? this._filtersQuery.getAll({ filterBy: (/**
             * @param {?} filter
             * @return {?}
             */
            filter => !filter.server) }) : this.getFilters();
    }
    /**
     * Select All Entity with apply filter to it, and updated with any change (entity or filter)
     * Will not apply sort, if need return   asObject:true !
     * @param {?=} options
     * @return {?}
     */
    selectAllByFilters(options) {
        if (options && options.asObject) {
            return combineLatest(this._selectFilters$, this.getQuery().selectAll(options)).pipe(map((/**
             * @param {?} __0
             * @return {?}
             */
            ([filters, entities]) => {
                /** @type {?} */
                const unkNowEntity = entities;
                return this._applyFiltersForHashMap(((/** @type {?} */ (unkNowEntity))), filters);
            })));
        }
        else {
            return combineLatest(this._selectFilters$, this.getQuery().selectAll(options), this.selectSortBy()).pipe(map((/**
             * @param {?} __0
             * @return {?}
             */
            ([filters, entities, sort]) => {
                /** @type {?} */
                const unkNowEntity = entities;
                return this._applyFiltersForArray(((/** @type {?} */ (unkNowEntity))), filters, sort);
            })));
        }
    }
    /**
     * Create or update a filter
     * @param {?} filter
     * @return {?}
     */
    setFilter(filter) {
        if (this._server && isUndefined(typeof filter.server)) {
            filter.server = true;
        }
        /** @type {?} */
        const entity = createFilter(filter);
        this.filtersStore.upsert(entity.id, entity);
    }
    /**
     * Remove a Filter
     * @param {?} id
     * @return {?}
     */
    removeFilter(id) {
        this.filtersStore.remove(id);
    }
    /**
     * Clear all filters
     * @return {?}
     */
    clearFilters() {
        this.filtersStore.remove();
    }
    /**
     * Get filter value, return null, if value not available
     * @template T
     * @param {?} id
     * @return {?}
     */
    getFilterValue(id) {
        if (this.filtersQuery.hasEntity(id)) {
            /** @type {?} */
            const entity = this.filtersQuery.getEntity(id);
            return entity.value ? entity.value : null;
        }
        return null;
    }
    /**
     * Get filter value, return null, if value not available
     * @return {?}
     */
    getSortValue() {
        /** @type {?} */
        const state = this.filtersQuery.getValue();
        return state.sort ? state.sort : null;
    }
    /**
     * Select Sort by value
     * @return {?}
     */
    selectSortBy() {
        return this._selectSortBy$;
    }
    /**
     * Set orderBy
     * @param {?} order
     * @return {?}
     */
    setSortBy(order) {
        this.filtersStore.update({ sort: order });
    }
    /**
     * Get the filters normalized as key value or as query params.
     * This can be useful for server-side filtering
     * @param {?=} options
     * @return {?}
     */
    getNormalizedFilters(options = {}) {
        /** @type {?} */
        const result = {};
        options = Object.assign({ sortByKey: 'sortBy', sortByOrderKey: 'sortByOrder' }, options);
        for (const filter of this.getServerFilters()) {
            result[filter.id] = filter.value;
        }
        if (options.withSort) {
            /** @type {?} */
            const sort = this.getSortValue();
            result[options.sortByKey] = sort.sortBy;
            result[options.sortByOrderKey] = sort.sortByOrder;
        }
        if (options.asQueryParams) {
            return this._serialize(result);
        }
        return result;
    }
    /**
     * @return {?}
     */
    destroy() {
        this.clearFilters();
    }
    /**
     * This method is responsible for getting access to the query.
     * @protected
     * @return {?}
     */
    getQuery() {
        return this.query;
    }
    /**
     * This method is responsible for getting access to the store.
     * @protected
     * @return {?}
     */
    getStore() {
        return this.getQuery().__store__;
    }
    /**
     * @private
     * @param {?} obj
     * @return {?}
     */
    _serialize(obj) {
        return Object.keys(obj)
            .map((/**
         * @param {?} k
         * @return {?}
         */
        k => `${encodeURIComponent(k)}=${encodeURIComponent(obj[k])}`))
            .join('&');
    }
    /**
     * @private
     * @param {?} entities
     * @param {?} filters
     * @param {?} sort
     * @return {?}
     */
    _applyFiltersForArray(entities, filters, sort) {
        /** @type {?} */
        let entitiesFiltered = entities;
        if (filters.length !== 0) {
            entitiesFiltered = entities.filter((/**
             * @param {?} entity
             * @param {?} index
             * @param {?} array
             * @return {?}
             */
            (entity, index, array) => {
                return filters.every((/**
                 * @param {?} filter
                 * @return {?}
                 */
                (filter) => {
                    if (filter.predicate) {
                        return !!filter.predicate(entity, index, array, filter);
                    }
                    return true;
                }));
            }));
        }
        if (sort && sort.sortBy) {
            /** @type {?} */
            const _sortBy = isFunction(sort.sortBy) ? sort.sortBy : compareValues(sort.sortBy, sort.sortByOrder);
            entitiesFiltered = [...entitiesFiltered.sort((/**
                 * @param {?} a
                 * @param {?} b
                 * @return {?}
                 */
                (a, b) => _sortBy(a, b, entities)))];
        }
        return entitiesFiltered;
    }
    /**
     * @private
     * @param {?} entities
     * @param {?} filters
     * @return {?}
     */
    _applyFiltersForHashMap(entities, filters) {
        if (filters.length === 0) {
            return entities;
        }
        /** @type {?} */
        const hashMapFiltered = {};
        Object.keys(entities).forEach((/**
         * @param {?} entityKey
         * @param {?} index
         * @return {?}
         */
        (entityKey, index) => {
            /** @type {?} */
            const entity = (/** @type {?} */ (entities[entityKey]));
            if (this._applyFiltersForOneEntity(filters, entity, index, entities)) {
                hashMapFiltered[entityKey] = entity;
            }
        }));
        return hashMapFiltered;
    }
    /**
     * @private
     * @param {?} filters
     * @param {?} entity
     * @param {?} index
     * @param {?} array
     * @return {?}
     */
    _applyFiltersForOneEntity(filters, entity, index, array) {
        return filters.every((/**
         * @param {?} filter
         * @return {?}
         */
        (filter) => {
            if (filter.predicate) {
                return !!filter.predicate(entity, index, array, filter);
            }
            return true;
        }));
    }
    /**
     * @protected
     * @param {?} id
     * @return {?}
     */
    instantiatePlugin(id) {
        return null;
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    AkitaFiltersPlugin.prototype._filtersStore;
    /**
     * @type {?}
     * @private
     */
    AkitaFiltersPlugin.prototype._filtersQuery;
    /**
     * @type {?}
     * @private
     */
    AkitaFiltersPlugin.prototype._server;
    /**
     * @type {?}
     * @private
     */
    AkitaFiltersPlugin.prototype._selectFilters$;
    /**
     * @type {?}
     * @private
     */
    AkitaFiltersPlugin.prototype._selectSortBy$;
    /**
     * @type {?}
     * @private
     */
    AkitaFiltersPlugin.prototype._selectFiltersAll$;
    /**
     * @type {?}
     * @protected
     */
    AkitaFiltersPlugin.prototype.query;
    /**
     * @type {?}
     * @private
     */
    AkitaFiltersPlugin.prototype.params;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWtpdGEtZmlsdGVycy1wbHVnaW4uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9ha2l0YS1maWx0ZXJzLXBsdWdpbi8iLCJzb3VyY2VzIjpbImxpYi9ha2l0YS1maWx0ZXJzLXBsdWdpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFjLGlCQUFpQixFQUFFLFlBQVksRUFBZSxNQUFNLHVCQUF1QixDQUFDO0FBQ2pHLE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLHVCQUF1QixDQUFDO0FBQ3hELE9BQU8sRUFBQyxhQUFhLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBa0MsTUFBTSxNQUFNLENBQUM7QUFDekYsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFDTCxhQUFhLEVBQ2Isc0JBQXNCLEVBT3RCLFVBQVUsRUFDVixXQUFXLEVBU1osTUFBTSxpQkFBaUIsQ0FBQzs7Ozs7QUFFekIsbUNBS0M7OztJQUpDLHlDQUEwQjs7SUFDMUIsa0NBQWtDOzs7Ozs7QUFLcEMsc0NBS0M7OztJQUpDLDJDQUFtQjs7SUFDbkIsZ0RBQXdCOztJQUN4Qiw0Q0FBbUI7O0lBQ25CLGlEQUF3Qjs7Ozs7QUFHMUIsTUFBTSxPQUFPLGtCQUNYLFNBQVEsc0JBQTRCOzs7OztJQVVwQyxZQUFzQixLQUFxQixFQUFVLFNBQTJCLEVBQUU7UUFDaEYsS0FBSyxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7UUFEWCxVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUFVLFdBQU0sR0FBTixNQUFNLENBQXVCO1FBTjFFLFlBQU8sR0FBWSxLQUFLLENBQUM7UUFRL0IsSUFBSSxDQUFDLE1BQU0saUJBQU8sRUFBQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsU0FBUyxHQUFHLFNBQVMsRUFBQyxFQUFLLE1BQU0sQ0FBQyxDQUFDO1FBRXhGLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxp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QUM7Q0FDRjs7Ozs7O0lBN1JDLDJDQUFxRDs7Ozs7SUFDckQsMkNBQXFEOzs7OztJQUNyRCxxQ0FBaUM7Ozs7O0lBRWpDLDZDQUFzRDs7Ozs7SUFDdEQsNENBQXFFOzs7OztJQUNyRSxnREFBa0U7Ozs7O0lBRXRELG1DQUErQjs7Ozs7SUFBRSxvQ0FBcUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0FraXRhRmlsdGVyLCBBa2l0YUZpbHRlcnNTdG9yZSwgY3JlYXRlRmlsdGVyLCBGaWx0ZXJzU3RhdGV9IGZyb20gJy4vYWtpdGEtZmlsdGVycy1zdG9yZSc7XG5pbXBvcnQge0FraXRhRmlsdGVyc1F1ZXJ5fSBmcm9tICcuL2FraXRhLWZpbHRlcnMtcXVlcnknO1xuaW1wb3J0IHtjb21iaW5lTGF0ZXN0LCBpc09ic2VydmFibGUsIG1lcmdlLCBPYnNlcnZhYmxlLCBPYnNlcnZlZFZhbHVlT2YsIG9mfSBmcm9tICdyeGpzJztcbmltcG9ydCB7bWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1xuICBjb21wYXJlVmFsdWVzLFxuICBFbnRpdHlDb2xsZWN0aW9uUGx1Z2luLFxuICBFbnRpdHlTdGF0ZSxcbiAgRW50aXR5U3RvcmUsXG4gIGdldEVudGl0eVR5cGUsXG4gIGdldElEVHlwZSxcbiAgSGFzaE1hcCxcbiAgSUQsXG4gIGlzRnVuY3Rpb24sXG4gIGlzVW5kZWZpbmVkLFxuICBPckFycmF5LFxuICBRdWVyeUVudGl0eSxcbiAgU2VsZWN0QWxsT3B0aW9uc0EsXG4gIFNlbGVjdEFsbE9wdGlvbnNCLFxuICBTZWxlY3RBbGxPcHRpb25zQyxcbiAgU2VsZWN0QWxsT3B0aW9uc0QsXG4gIFNlbGVjdEFsbE9wdGlvbnNFLFxuICBTb3J0QnlPcHRpb25zXG59IGZyb20gJ0BkYXRvcmFtYS9ha2l0YSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRmlsdGVyc1BhcmFtczxTIGV4dGVuZHMgRW50aXR5U3RhdGU+IHtcbiAgZmlsdGVyc1N0b3JlTmFtZT86IHN0cmluZztcbiAgZW50aXR5SWRzPzogT3JBcnJheTxnZXRJRFR5cGU8Uz4+O1xuXG4gIFtrZXk6IHN0cmluZ106IGFueTtcbn1cblxuaW50ZXJmYWNlIE5vcm1hbGl6ZWRGaWx0ZXJPcHRpb25zIHtcbiAgd2l0aFNvcnQ/OiBib29sZWFuO1xuICBhc1F1ZXJ5UGFyYW1zPzogYm9vbGVhbjtcbiAgc29ydEJ5S2V5Pzogc3RyaW5nO1xuICBzb3J0QnlPcmRlcktleT86IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIEFraXRhRmlsdGVyc1BsdWdpbjxTIGV4dGVuZHMgRW50aXR5U3RhdGUsIEUgPSBnZXRFbnRpdHlUeXBlPFM+LCBJID0gT3JBcnJheTxnZXRJRFR5cGU8Uz4+LCBQID0gYW55PlxuICBleHRlbmRzIEVudGl0eUNvbGxlY3Rpb25QbHVnaW48UywgUD4ge1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgX2ZpbHRlcnNTdG9yZTogQWtpdGFGaWx0ZXJzU3RvcmU8Uz47XG4gIHByaXZhdGUgcmVhZG9ubHkgX2ZpbHRlcnNRdWVyeTogQWtpdGFGaWx0ZXJzUXVlcnk8Uz47XG4gIHByaXZhdGUgX3NlcnZlcjogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIHByaXZhdGUgX3NlbGVjdEZpbHRlcnMkOiBPYnNlcnZhYmxlPEFraXRhRmlsdGVyPFM+W10+O1xuICBwcml2YXRlIHJlYWRvbmx5IF9zZWxlY3RTb3J0QnkkOiBPYnNlcnZhYmxlPFNvcnRCeU9wdGlvbnM8RT4gfCBudWxsPjtcbiAgcHJpdmF0ZSByZWFkb25seSBfc2VsZWN0RmlsdGVyc0FsbCQ6IE9ic2VydmFibGU8QWtpdGFGaWx0ZXI8Uz5bXT47XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIHF1ZXJ5OiBRdWVyeUVudGl0eTxTPiwgcHJpdmF0ZSBwYXJhbXM6IEZpbHRlcnNQYXJhbXM8Uz4gPSB7fSkge1xuICAgIHN1cGVyKHF1ZXJ5LCBwYXJhbXMuZW50aXR5SWRzKTtcbiAgICB0aGlzLnBhcmFtcyA9IHsuLi57ZmlsdGVyc1N0b3JlTmFtZTogdGhpcy5nZXRTdG9yZSgpLnN0b3JlTmFtZSArICdGaWx0ZXJzJ30sIC4uLnBhcmFtc307XG5cbiAgICB0aGlzLl9maWx0ZXJzU3RvcmUgPSBuZXcgQWtpdGFGaWx0ZXJzU3RvcmU8Uz4odGhpcy5wYXJhbXMuZmlsdGVyc1N0b3JlTmFtZSk7XG4gICAgdGhpcy5fZmlsdGVyc1F1ZXJ5ID0gbmV3IEFraXRhRmlsdGVyc1F1ZXJ5PFM+KHRoaXMuX2ZpbHRlcnNTdG9yZSk7XG5cbiAgICB0aGlzLl9zZWxlY3RGaWx0ZXJzJCA9IHRoaXMuZmlsdGVyc1F1ZXJ5LnNlbGVjdEFsbCh7c29ydEJ5OiAnb3JkZXInfSk7XG4gICAgdGhpcy5fc2VsZWN0RmlsdGVyc0FsbCQgPSB0aGlzLmZpbHRlcnNRdWVyeS5zZWxlY3RBbGwoe3NvcnRCeTogJ29yZGVyJywgZmlsdGVyQnk6IGZpbHRlciA9PiAhZmlsdGVyLmhpZGV9KTtcbiAgICB0aGlzLl9zZWxlY3RTb3J0QnkkID0gdGhpcy5maWx0ZXJzUXVlcnkuc2VsZWN0KHN0YXRlID0+IHN0YXRlICYmIHN0YXRlLnNvcnQgPyBzdGF0ZS5zb3J0IDogbnVsbCk7XG4gIH1cblxuICBnZXQgZmlsdGVyc1N0b3JlKCk6IEFraXRhRmlsdGVyc1N0b3JlPFM+IHtcbiAgICByZXR1cm4gdGhpcy5fZmlsdGVyc1N0b3JlO1xuICB9XG5cbiAgZ2V0IGZpbHRlcnNRdWVyeSgpOiBBa2l0YUZpbHRlcnNRdWVyeTxTPiB7XG4gICAgcmV0dXJuIHRoaXMuX2ZpbHRlcnNRdWVyeTtcbiAgfVxuXG4gIC8qKlxuICAgKiAgQWRkIHN1cHBvcnQgb2YgZmlsdGVycyBmcm9tIHNlcnZlci4gUHJvdmlkZSBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsIGVhY2ggdGltZSBhIGZpbHRlciBjaGFuZ2VzXG4gICAqXG4gICAqICBuZXcgQWtpdGFGaWx0ZXJQbHVnaW5zKHF1ZXJ5KS53aXRoU2VydmVyKChmaWx0ZXJzKSA9PiB7XG4gICAqICAgICAgcmV0dXJuIHRoaXMuYXBpLmdldERhdGEoZmlsdGVycyk7XG4gICAqICB9KTtcbiAgICpcbiAgICogIFJldHVybiBmYWxzZSB0byBub3QgYWRkIGluIHN0b3JlLiBpZiB5b3Ugd2FudCB0byBtYW5hZ2UgdGhlIHN0b3JlIGluIHlvdXIgb3duLlxuICAgKi9cbiAgd2l0aFNlcnZlcihcbiAgICBvbkNoYW5nZUZpbHRlcjogKGZpbHRlcnNOb3JtYWxpemVkOiBzdHJpbmcgfCBIYXNoTWFwPGFueT4pID0+IGFueSB8IGJvb2xlYW4sXG4gICAgb3B0aW9uczogTm9ybWFsaXplZEZpbHRlck9wdGlvbnMgPSB7fSk6IEFraXRhRmlsdGVyc1BsdWdpbjxTLCBFLCBJLCBQPiB7XG4gICAgdGhpcy5fc2VydmVyID0gdHJ1ZTtcblxuICAgIC8vIENoYW5nZSBkZWZhdWx0IHNlbGVjdCBmaWx0ZXJzIHRvIHJlbW92ZSBzZXJ2ZXIgZmlsdGVycywgaWYgeW91IHVzZSBzZWxlY3RBbGxCeUZpbHRlcnMoKTtcbiAgICB0aGlzLl9zZWxlY3RGaWx0ZXJzJCA9IHRoaXMuX2ZpbHRlcnNRdWVyeS5zZWxlY3RBbGwoe3NvcnRCeTogJ29yZGVyJywgZmlsdGVyQnk6IGZpbHRlciA9PiAhZmlsdGVyLnNlcnZlcn0pO1xuXG4gICAgY29uc3QgbGlzdE9ic2VydmFibGU6IEFycmF5PE9ic2VydmFibGU8YW55Pj4gPSBbXTtcbiAgICBsaXN0T2JzZXJ2YWJsZS5wdXNoKHRoaXMuX2ZpbHRlcnNRdWVyeS5zZWxlY3RBbGwoe3NvcnRCeTogJ29yZGVyJywgZmlsdGVyQnk6IGZpbHRlciA9PiBmaWx0ZXIuc2VydmVyfSkpO1xuXG4gICAgaWYgKG9wdGlvbnMud2l0aFNvcnQpIHtcbiAgICAgIGxpc3RPYnNlcnZhYmxlLnB1c2godGhpcy5zZWxlY3RTb3J0QnkoKSk7XG4gICAgfVxuICAgIG1lcmdlPE9ic2VydmFibGU8Z2V0RW50aXR5VHlwZTxTPltdPiB8IE9ic2VydmFibGU8U29ydEJ5T3B0aW9uczxFPiB8IG51bGw+PihsaXN0T2JzZXJ2YWJsZSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIGNvbnN0IHJldHVybk9uQ2hhbmdlOiBib29sZWFuIHwgT2JzZXJ2YWJsZTxnZXRFbnRpdHlUeXBlPFM+W10+ID0gb25DaGFuZ2VGaWx0ZXIodGhpcy5nZXROb3JtYWxpemVkRmlsdGVycyhvcHRpb25zKSk7XG5cbiAgICAgIGlmIChyZXR1cm5PbkNoYW5nZSAhPT0gZmFsc2UgJiYgaXNPYnNlcnZhYmxlKHJldHVybk9uQ2hhbmdlKSkge1xuICAgICAgICByZXR1cm5PbkNoYW5nZS5zdWJzY3JpYmUoKG5ld1ZhbHVlOiBnZXRFbnRpdHlUeXBlPFM+W10pID0+IHtcbiAgICAgICAgICB0aGlzLmdldFN0b3JlKCkuc2V0KG5ld1ZhbHVlKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKiogUmV0dXJuIHRydWUsIGlmIHNlcnZlciBpcyBjb25maWd1cmVkICoqL1xuICBoYXNTZXJ2ZXIoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX3NlcnZlcjtcbiAgfVxuXG4gIC8qKlxuICAgKiAgU2VsZWN0IGFsbCBmaWx0ZXJzXG4gICAqXG4gICAqICBOb3RlOiBPbmx5IGFsbCBmaWx0ZXJzIG5vdCBoaWRlZCAod2l0aCBoaWRlPXRydWUpLCB3aWxsIG5vdCBiZSBkaXNwbGF5ZWQuIElmIHlvdSB3YW50IGl0LCBjYWxsIGRpcmVjdGx5IHRvOlxuICAgKiBgdGhpcy5maWx0ZXJzUXVlcnkuc2VsZWN0QWxsKClgXG4gICAqXG4gICAqXG4gICAqL1xuICBzZWxlY3RGaWx0ZXJzKCk6IE9ic2VydmFibGU8QWtpdGFGaWx0ZXI8Uz5bXT4ge1xuICAgIHJldHVybiB0aGlzLl9zZWxlY3RGaWx0ZXJzQWxsJDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYWxsIHRoZSBjdXJyZW50IHNuYXBzaG90IGZpbHRlcnNcbiAgICpcbiAgICogIE5vdGU6IGZpbHRlcnMgd2l0aCBoaWRlPXRydWUsIHdpbGwgbm90IGJlIGRpc3BsYXllZC4gSWYgeW91IHdhbnQgaXQsIGNhbGwgZGlyZWN0bHkgdG86XG4gICAqIGB0aGlzLmZpbHRlcnNRdWVyeS5nZXRBbGwoKWBcbiAgICovXG4gIGdldEZpbHRlcnMoKTogQWtpdGFGaWx0ZXI8Uz5bXSB7XG4gICAgcmV0dXJuIHRoaXMuX2ZpbHRlcnNRdWVyeS5nZXRBbGwoe2ZpbHRlckJ5OiBmaWx0ZXIgPT4gIWZpbHRlci5oaWRlfSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFsbCB0aGUgY3VycmVudCBzbmFwc2hvdCBzZXJ2ZXIgZmlsdGVycyAob25seSBpZiBzZXJ2ZXIgaXMgYXZhaWxhYmxlIGVsc2UgcmV0dXJuIGRlZmF1bHQgbm90IGhpZGRlbiBmaWx0ZXJzKVxuICAgKlxuICAgKiAgTm90ZTogZmlsdGVycyB3aXRoIHNlcnZlcj1mYWxzZSwgd2lsbCBub3QgYmUgZGlzcGxheWVkLiBJZiB5b3Ugd2FudCBpdCwgY2FsbCBkaXJlY3RseSB0bzpcbiAgICogYHRoaXMuZmlsdGVyc1F1ZXJ5LmdldEFsbCgpYFxuICAgKi9cbiAgZ2V0U2VydmVyRmlsdGVycygpOiBBa2l0YUZpbHRlcjxTPltdIHtcbiAgICByZXR1cm4gdGhpcy5fc2VydmVyID8gdGhpcy5fZmlsdGVyc1F1ZXJ5LmdldEFsbCh7ZmlsdGVyQnk6IGZpbHRlciA9PiAhZmlsdGVyLnNlcnZlcn0pIDogdGhpcy5nZXRGaWx0ZXJzKCk7XG4gIH1cblxuICAvKipcbiAgICogU2VsZWN0IEFsbCBFbnRpdHkgd2l0aCBhcHBseSBmaWx0ZXIgdG8gaXQsIGFuZCB1cGRhdGVkIHdpdGggYW55IGNoYW5nZSAoZW50aXR5IG9yIGZpbHRlcilcbiAgICogV2lsbCBub3QgYXBwbHkgc29ydCwgaWYgbmVlZCByZXR1cm4gICBhc09iamVjdDp0cnVlICFcbiAgICovXG4gIHNlbGVjdEFsbEJ5RmlsdGVycyhvcHRpb25zPzogU2VsZWN0QWxsT3B0aW9uc0E8RT5cbiAgICB8IFNlbGVjdEFsbE9wdGlvbnNCPEU+IHwgU2VsZWN0QWxsT3B0aW9uc0M8RT4gfFxuICAgIFNlbGVjdEFsbE9wdGlvbnNEPEU+IHwgU2VsZWN0QWxsT3B0aW9uc0U8RT4gfCBhbnkpOiBPYnNlcnZhYmxlPGdldEVudGl0eVR5cGU8Uz5bXSB8IEhhc2hNYXA8Z2V0RW50aXR5VHlwZTxTPj4+IHtcbiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmFzT2JqZWN0KSB7XG4gICAgICByZXR1cm4gY29tYmluZUxhdGVzdCh0aGlzLl9zZWxlY3RGaWx0ZXJzJCwgdGhpcy5nZXRRdWVyeSgpLnNlbGVjdEFsbChvcHRpb25zKSkucGlwZShcbiAgICAgICAgbWFwKChbZmlsdGVycywgZW50aXRpZXNdKSA9PiB7XG4gICAgICAgICAgY29uc3QgdW5rTm93RW50aXR5OiB1bmtub3duID0gZW50aXRpZXM7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX2FwcGx5RmlsdGVyc0Zvckhhc2hNYXAoKHVua05vd0VudGl0eSBhcyBIYXNoTWFwPGdldEVudGl0eVR5cGU8Uz4+KSwgZmlsdGVycyk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG5cbiAgICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KHRoaXMuX3NlbGVjdEZpbHRlcnMkLCB0aGlzLmdldFF1ZXJ5KCkuc2VsZWN0QWxsKG9wdGlvbnMpLCB0aGlzLnNlbGVjdFNvcnRCeSgpKS5waXBlKFxuICAgICAgICBtYXAoKFtmaWx0ZXJzLCBlbnRpdGllcywgc29ydF0pID0+IHtcbiAgICAgICAgICBjb25zdCB1bmtOb3dFbnRpdHk6IHVua25vd24gPSBlbnRpdGllcztcbiAgICAgICAgICByZXR1cm4gdGhpcy5fYXBwbHlGaWx0ZXJzRm9yQXJyYXkoKHVua05vd0VudGl0eSBhcyBnZXRFbnRpdHlUeXBlPFM+W10pLCBmaWx0ZXJzLCBzb3J0KTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBvciB1cGRhdGUgYSBmaWx0ZXJcbiAgICovXG4gIHNldEZpbHRlcihmaWx0ZXI6IFBhcnRpYWw8QWtpdGFGaWx0ZXI8Uz4+KSB7XG4gICAgaWYgKHRoaXMuX3NlcnZlciAmJiBpc1VuZGVmaW5lZCh0eXBlb2YgZmlsdGVyLnNlcnZlcikpIHtcbiAgICAgIGZpbHRlci5zZXJ2ZXIgPSB0cnVlO1xuICAgIH1cbiAgICBjb25zdCBlbnRpdHkgPSBjcmVhdGVGaWx0ZXIoZmlsdGVyKTtcbiAgICB0aGlzLmZpbHRlcnNTdG9yZS51cHNlcnQoZW50aXR5LmlkLCBlbnRpdHkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBhIEZpbHRlclxuICAgKi9cbiAgcmVtb3ZlRmlsdGVyKGlkOiBJRCkge1xuICAgIHRoaXMuZmlsdGVyc1N0b3JlLnJlbW92ZShpZCk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgYWxsIGZpbHRlcnNcbiAgICovXG4gIGNsZWFyRmlsdGVycygpIHtcbiAgICB0aGlzLmZpbHRlcnNTdG9yZS5yZW1vdmUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgZmlsdGVyIHZhbHVlLCByZXR1cm4gbnVsbCwgaWYgdmFsdWUgbm90IGF2YWlsYWJsZVxuICAgKi9cbiAgZ2V0RmlsdGVyVmFsdWU8VCA9IGFueT4oaWQ6IHN0cmluZyk6IFQgfCBudWxsIHtcbiAgICBpZiAodGhpcy5maWx0ZXJzUXVlcnkuaGFzRW50aXR5KGlkKSkge1xuICAgICAgY29uc3QgZW50aXR5OiBBa2l0YUZpbHRlcjxTPiA9IHRoaXMuZmlsdGVyc1F1ZXJ5LmdldEVudGl0eShpZCk7XG4gICAgICByZXR1cm4gZW50aXR5LnZhbHVlID8gZW50aXR5LnZhbHVlIDogbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgZmlsdGVyIHZhbHVlLCByZXR1cm4gbnVsbCwgaWYgdmFsdWUgbm90IGF2YWlsYWJsZVxuICAgKi9cbiAgZ2V0U29ydFZhbHVlKCk6IFNvcnRCeU9wdGlvbnM8RT4gfCBudWxsIHtcbiAgICBjb25zdCBzdGF0ZTogRmlsdGVyc1N0YXRlPFM+ID0gdGhpcy5maWx0ZXJzUXVlcnkuZ2V0VmFsdWUoKTtcbiAgICByZXR1cm4gc3RhdGUuc29ydCA/IHN0YXRlLnNvcnQgOiBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdCBTb3J0IGJ5IHZhbHVlXG4gICAqL1xuICBwdWJsaWMgc2VsZWN0U29ydEJ5KCk6IE9ic2VydmFibGU8U29ydEJ5T3B0aW9uczxFPiB8IG51bGw+IHtcbiAgICByZXR1cm4gdGhpcy5fc2VsZWN0U29ydEJ5JDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgb3JkZXJCeVxuICAgKi9cbiAgc2V0U29ydEJ5KG9yZGVyOiBTb3J0QnlPcHRpb25zPEU+KSB7XG4gICAgdGhpcy5maWx0ZXJzU3RvcmUudXBkYXRlKHtzb3J0OiBvcmRlcn0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgZmlsdGVycyBub3JtYWxpemVkIGFzIGtleSB2YWx1ZSBvciBhcyBxdWVyeSBwYXJhbXMuXG4gICAqIFRoaXMgY2FuIGJlIHVzZWZ1bCBmb3Igc2VydmVyLXNpZGUgZmlsdGVyaW5nXG4gICAqL1xuICBnZXROb3JtYWxpemVkRmlsdGVycyhvcHRpb25zOiBOb3JtYWxpemVkRmlsdGVyT3B0aW9ucyA9IHt9KTogc3RyaW5nIHwgSGFzaE1hcDxhbnk+IHtcbiAgICBjb25zdCByZXN1bHQgPSB7fTtcbiAgICBvcHRpb25zID0ge3NvcnRCeUtleTogJ3NvcnRCeScsIHNvcnRCeU9yZGVyS2V5OiAnc29ydEJ5T3JkZXInLCAuLi5vcHRpb25zfTtcblxuICAgIGZvciAoY29uc3QgZmlsdGVyIG9mIHRoaXMuZ2V0U2VydmVyRmlsdGVycygpKSB7XG4gICAgICByZXN1bHRbZmlsdGVyLmlkXSA9IGZpbHRlci52YWx1ZTtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy53aXRoU29ydCkge1xuICAgICAgY29uc3Qgc29ydCA9IHRoaXMuZ2V0U29ydFZhbHVlKCk7XG4gICAgICByZXN1bHRbb3B0aW9ucy5zb3J0QnlLZXldID0gc29ydC5zb3J0Qnk7XG4gICAgICByZXN1bHRbb3B0aW9ucy5zb3J0QnlPcmRlcktleV0gPSBzb3J0LnNvcnRCeU9yZGVyO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLmFzUXVlcnlQYXJhbXMpIHtcbiAgICAgIHJldHVybiB0aGlzLl9zZXJpYWxpemUocmVzdWx0KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgZGVzdHJveSgpIHtcbiAgICB0aGlzLmNsZWFyRmlsdGVycygpO1xuICB9XG5cblxuXG4gIC8qKiBUaGlzIG1ldGhvZCBpcyByZXNwb25zaWJsZSBmb3IgZ2V0dGluZyBhY2Nlc3MgdG8gdGhlIHF1ZXJ5LiAqL1xuICBwcm90ZWN0ZWQgZ2V0UXVlcnkoKTogUXVlcnlFbnRpdHk8Uz4ge1xuICAgIHJldHVybiB0aGlzLnF1ZXJ5O1xuICB9XG5cbiAgLyoqIFRoaXMgbWV0aG9kIGlzIHJlc3BvbnNpYmxlIGZvciBnZXR0aW5nIGFjY2VzcyB0byB0aGUgc3RvcmUuICovXG4gIHByb3RlY3RlZCBnZXRTdG9yZSgpOiBFbnRpdHlTdG9yZTxTPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UXVlcnkoKS5fX3N0b3JlX187XG4gIH1cblxuICBwcml2YXRlIF9zZXJpYWxpemUob2JqKSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKG9iailcbiAgICAgIC5tYXAoayA9PiBgJHtlbmNvZGVVUklDb21wb25lbnQoayl9PSR7ZW5jb2RlVVJJQ29tcG9uZW50KG9ialtrXSl9YClcbiAgICAgIC5qb2luKCcmJyk7XG4gIH1cblxuICBwcml2YXRlIF9hcHBseUZpbHRlcnNGb3JBcnJheShcbiAgICBlbnRpdGllczogZ2V0RW50aXR5VHlwZTxTPltdLFxuICAgIGZpbHRlcnM6IEFraXRhRmlsdGVyPFM+W10sXG4gICAgc29ydDogT2JzZXJ2ZWRWYWx1ZU9mPE9ic2VydmFibGU8U29ydEJ5T3B0aW9uczxFPiB8IG51bGw+Pik6IGdldEVudGl0eVR5cGU8Uz5bXSB7XG4gICAgbGV0IGVudGl0aWVzRmlsdGVyZWQgPSBlbnRpdGllcztcbiAgICBpZiAoZmlsdGVycy5sZW5ndGggIT09IDApIHtcbiAgICAgIGVudGl0aWVzRmlsdGVyZWQgPSBlbnRpdGllcy5maWx0ZXIoKGVudGl0eTogZ2V0RW50aXR5VHlwZTxTPiwgaW5kZXg6IG51bWJlciwgYXJyYXk6IGdldEVudGl0eVR5cGU8Uz5bXSkgPT4ge1xuICAgICAgICByZXR1cm4gZmlsdGVycy5ldmVyeSgoZmlsdGVyOiBBa2l0YUZpbHRlcjxTPikgPT4ge1xuICAgICAgICAgIGlmIChmaWx0ZXIucHJlZGljYXRlKSB7XG4gICAgICAgICAgICByZXR1cm4gISFmaWx0ZXIucHJlZGljYXRlKGVudGl0eSwgaW5kZXgsIGFycmF5LCBmaWx0ZXIpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoc29ydCAmJiBzb3J0LnNvcnRCeSkge1xuICAgICAgY29uc3QgX3NvcnRCeTogYW55ID0gaXNGdW5jdGlvbihzb3J0LnNvcnRCeSkgPyBzb3J0LnNvcnRCeSA6IGNvbXBhcmVWYWx1ZXMoc29ydC5zb3J0QnksIHNvcnQuc29ydEJ5T3JkZXIpO1xuICAgICAgZW50aXRpZXNGaWx0ZXJlZCA9IFsuLi5lbnRpdGllc0ZpbHRlcmVkLnNvcnQoKGEsIGIpID0+IF9zb3J0QnkoYSwgYiwgZW50aXRpZXMpKV07XG4gICAgfVxuICAgIHJldHVybiBlbnRpdGllc0ZpbHRlcmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBfYXBwbHlGaWx0ZXJzRm9ySGFzaE1hcChcbiAgICBlbnRpdGllczogSGFzaE1hcDxnZXRFbnRpdHlUeXBlPFM+PixcbiAgICBmaWx0ZXJzOiBBa2l0YUZpbHRlcjxTPltdKTogSGFzaE1hcDxnZXRFbnRpdHlUeXBlPFM+PiB7XG4gICAgaWYgKGZpbHRlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gZW50aXRpZXM7XG4gICAgfVxuICAgICAgY29uc3QgaGFzaE1hcEZpbHRlcmVkOiBIYXNoTWFwPGdldEVudGl0eVR5cGU8Uz4+ID0ge307XG4gICAgICBPYmplY3Qua2V5cyhlbnRpdGllcykuZm9yRWFjaCgoZW50aXR5S2V5OiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgY29uc3QgZW50aXR5OiBnZXRFbnRpdHlUeXBlPFM+ID0gZW50aXRpZXNbZW50aXR5S2V5XSBhcyBnZXRFbnRpdHlUeXBlPFM+O1xuICAgICAgICBpZiAodGhpcy5fYXBwbHlGaWx0ZXJzRm9yT25lRW50aXR5KGZpbHRlcnMsIGVudGl0eSwgaW5kZXgsIGVudGl0aWVzKSkge1xuICAgICAgICAgIGhhc2hNYXBGaWx0ZXJlZFtlbnRpdHlLZXldID0gZW50aXR5O1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIGhhc2hNYXBGaWx0ZXJlZDtcbiAgfVxuXG4gIHByaXZhdGUgX2FwcGx5RmlsdGVyc0Zvck9uZUVudGl0eShmaWx0ZXJzOiBBa2l0YUZpbHRlcjxTPltdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5OiBnZXRFbnRpdHlUeXBlPFM+LCBpbmRleDogbnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXk6IGdldEVudGl0eVR5cGU8Uz5bXSB8IEhhc2hNYXA8Z2V0RW50aXR5VHlwZTxTPj4pIHtcbiAgICByZXR1cm4gZmlsdGVycy5ldmVyeSgoZmlsdGVyOiBBa2l0YUZpbHRlcjxTPikgPT4ge1xuICAgICAgaWYgKGZpbHRlci5wcmVkaWNhdGUpIHtcbiAgICAgICAgcmV0dXJuICEhZmlsdGVyLnByZWRpY2F0ZShlbnRpdHksIGluZGV4LCBhcnJheSwgZmlsdGVyKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0pO1xuICB9XG5cbiAgcHJvdGVjdGVkIGluc3RhbnRpYXRlUGx1Z2luKGlkOiBJKTogUCB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cbiJdfQ==