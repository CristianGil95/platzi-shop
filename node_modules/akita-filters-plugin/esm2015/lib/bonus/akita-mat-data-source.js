/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { DataSource } from '@angular/cdk/table';
import { BehaviorSubject, combineLatest, merge, of, Subject, Subscription } from 'rxjs';
import { Order } from '@datorama/akita';
import { AkitaFiltersPlugin } from '../akita-filters-plugin';
import { map, takeUntil } from 'rxjs/operators';
/**
 * @template S, E
 */
export class AkitaMatDataSource extends DataSource {
    /**
     * Data source to use an Akita EntityStore with a Material table
     * @see : https://material.angular.io/components/table/overview
     *
     * @param {?} query string : [Mandatory] the akita Query Entity, you wan to use to this data source.
     * @param {?=} akitaFilters string [Optional] If you want to provide an AkitaFilters that you use externally. Else it will create a new one.
     */
    constructor(query, akitaFilters) {
        super();
        this._paginator = null;
        this._sort = null;
        /**
         * Used to react to internal changes of the paginator that are made by the data source itself.
         */
        this._internalPageChanges = new Subject();
        /**
         * Stream emitting render data to the table (depends on ordered data changes).
         */
        this._renderData = new BehaviorSubject([]);
        /**
         * Used to react to internal changes of the paginator that are made by the data source itself.
         */
        this._disconnect = new Subject();
        /**
         * Subscription to the changes that should trigger an update to the table's rendered rows, such
         * as filtering, sorting, pagination, or base data changes.
         */
        this._renderChangesSubscription = Subscription.EMPTY;
        this._dataQuery = query;
        this._filters = akitaFilters ? akitaFilters : new AkitaFiltersPlugin(query);
        this._hasCustomFilters = !!akitaFilters;
        this._count$ = new BehaviorSubject(0);
        /** @type {?} */
        let count = 0;
        // @ts-ignore ignore, as without options, we will allways have an Array.
        this._selectAllByFilter$ = this._filters.selectAllByFilters();
        this._updateChangeSubscription();
    }
    /**
     * @param {?} searchQuery teh string use to search
     * @return {?}
     */
    set filter(searchQuery) {
        this.search = searchQuery;
    }
    /**
     * filter all the list by a search term.
     *
     * use like a property :
     * akitaMatDataSourceInstance.search = 'term';
     * @param {?} searchQuery the string use to search
     * @return {?}
     */
    set search(searchQuery) {
        if (searchQuery === '') {
            this._filters.removeFilter('search');
        }
        else {
            this._filters.setFilter({ id: 'search', value: searchQuery });
        }
    }
    /**
     * Instance of the MatSort directive used by the table to control its sorting. Sort changes
     * emitted by the MatSort will trigger an update to the table's rendered data.
     * @param {?} sort
     * @return {?}
     */
    set sort(sort) {
        this._sort = sort;
        sort.sortChange.pipe(takeUntil(this._disconnect)).subscribe((/**
         * @param {?} sortValue
         * @return {?}
         */
        (sortValue) => {
            this._filters.setSortBy({
                sortBy: (/** @type {?} */ (sortValue.active)),
                sortByOrder: sortValue.direction === 'desc' ? Order.DESC : Order.ASC
            });
        }));
        sort.initialized.subscribe((/**
         * @return {?}
         */
        () => {
            this.setDefaultSort((/** @type {?} */ (sort.active)), sort.direction === 'desc' ? Order.DESC : Order.ASC);
        }));
    }
    /**
     * Instance of the MatPaginator component used by the table to control what page of the data is
     * displayed. Page changes emitted by the MatPaginator will trigger an update to the
     * table's rendered data.
     *
     * Note that the data source uses the paginator's properties to calculate which page of data
     * should be displayed. If the paginator receives its properties as template inputs,
     * e.g. `[pageLength]=100` or `[pageIndex]=1`, then be sure that the paginator's view has been
     * initialized before assigning it to this data source.
     * @return {?}
     */
    get paginator() {
        return this._paginator;
    }
    /**
     * @param {?} paginator
     * @return {?}
     */
    set paginator(paginator) {
        this._paginator = paginator;
        this._updateChangeSubscription();
    }
    /**
     * @deprecated use get akitaFiltersPlugin
     * @return {?}
     */
    get AkitaFilters() {
        return this._filters;
    }
    /**
     * Access to AkitaFiltersPlugins, usefull to interact with all filters
     * @return {?}
     */
    get akitaFiltersPlugIn() {
        return this._filters;
    }
    /**
     * @private
     * @param {?} value
     * @return {?}
     */
    _updateCount(value) {
        /** @type {?} */
        const count = value.length ? value.length : 0;
        if (count !== this._count$.getValue()) {
            this._count$.next(count);
            this._updatePaginator(count);
        }
    }
    /**
     * Paginate the data (client-side). If you're using server-side pagination,
     * this would be replaced by requesting the appropriate data from the server.
     * @private
     * @param {?} data
     * @return {?}
     */
    _pageData(data) {
        this._updateCount(data);
        if (!this.paginator) {
            return data;
        }
        /** @type {?} */
        const startIndex = this.paginator.pageIndex * this.paginator.pageSize;
        return data.slice(startIndex, startIndex + this.paginator.pageSize);
    }
    /**
     *  add a filter to filters plugins
     * @param {?} filter
     * @return {?}
     */
    addFilter(filter) {
        this._filters.setFilter(filter);
    }
    /**
     *  add a filter to filters plugins
     * @param {?} filter
     * @return {?}
     */
    setFilter(filter) {
        this._filters.setFilter(filter);
    }
    /**
     * Remove a AkitaFilter
     * @param {?} id
     * @return {?}
     */
    removeFilter(id) {
        this._filters.removeFilter(id);
    }
    /**
     * Clear all filters
     * @return {?}
     */
    clearFilters() {
        this._filters.clearFilters();
    }
    /**
     * Get filter value, return null, if value not available
     * @template V
     * @param {?} id
     * @return {?}
     */
    getFilterValue(id) {
        return this._filters.getFilterValue(id);
    }
    /**
     * Set the default sort
     * @param {?} sortColumn the colum name present in your object
     * @param {?=} direction string the direction for sorting (asc or desc). Default asc.
     * @return {?}
     */
    setDefaultSort(sortColumn, direction = 'asc') {
        this._filters.setSortBy({
            sortBy: sortColumn,
            sortByOrder: direction === 'desc' ? Order.DESC : Order.ASC
        });
    }
    /**
     * Select Count filtered results.
     * @return {?}
     */
    selectCount() {
        return this._count$.asObservable();
    }
    /**
     * Select Count filtered results.
     * @return {?}
     */
    getCount() {
        return this._count$.getValue();
    }
    /**
     * Subscribe to changes that should trigger an update to the table's rendered rows. When the
     * changes occur, process the current state of the filter, sort, and pagination along with
     * the provided base data and send it to the table for rendering.
     * @return {?}
     */
    _updateChangeSubscription() {
        // Sorting and/or pagination should be watched if MatSort and/or MatPaginator are provided.
        // The events should emit whenever the component emits a change or initializes, or if no
        // component is provided, a stream with just a null event should be provided.
        // The `sortChange` and `pageChange` acts as a signal to the combineLatests below so that the
        // pipeline can progress to the next step. Note that the value from these streams are not used,
        // they purely act as a signal to progress in the pipeline.
        // Sorting and/or pagination should be watched if MatSort and/or MatPaginator are provided.
        // The events should emit whenever the component emits a change or initializes, or if no
        // component is provided, a stream with just a null event should be provided.
        // The `sortChange` and `pageChange` acts as a signal to the combineLatests below so that the
        // pipeline can progress to the next step. Note that the value from these streams are not used,
        // they purely act as a signal to progress in the pipeline.
        /** @type {?} */
        const pageChange = this._paginator ?
            (/** @type {?} */ (merge(this._paginator.page, this._internalPageChanges, this._paginator.initialized))) :
            of(null);
        /** @type {?} */
        const paginatedData = combineLatest(this._selectAllByFilter$, pageChange)
            .pipe(map((/**
         * @param {?} __0
         * @return {?}
         */
        ([data]) => this._pageData(data))));
        // Watched for paged data changes and send the result to the table to render.
        this._renderChangesSubscription.unsubscribe();
        this._renderChangesSubscription = paginatedData.pipe(takeUntil(this._disconnect)).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        data => this._renderData.next(data)));
        this._internalPageChanges.next();
    }
    /**
     * Updates the paginator to reflect the length of the filtered data, and makes sure that the page
     * index does not exceed the paginator's last page. Values are changed in a resolved promise to
     * guard against making property changes within a round of change detection.
     * @param {?} filteredDataLength
     * @return {?}
     */
    _updatePaginator(filteredDataLength) {
        Promise.resolve().then((/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const paginator = this.paginator;
            if (!paginator) {
                return;
            }
            paginator.length = filteredDataLength;
            // If the page index is set beyond the page, reduce it to the last page.
            if (paginator.pageIndex > 0) {
                /** @type {?} */
                const lastPageIndex = Math.ceil(paginator.length / paginator.pageSize) - 1 || 0;
                /** @type {?} */
                const newPageIndex = Math.min(paginator.pageIndex, lastPageIndex);
                if (newPageIndex !== paginator.pageIndex) {
                    paginator.pageIndex = newPageIndex;
                    // Since the paginator only emits after user-generated changes,
                    // we need our own stream so we know to should re-render the data.
                    this._internalPageChanges.next();
                }
            }
        }));
    }
    /**
     * Function used by matTable to subscribe to the data
     * @return {?}
     */
    connect() {
        return this._renderData;
    }
    /**
     * Used by the MatTable. Called when it is destroyed. No-op.
     * \@docs-private
     * @return {?}
     */
    disconnect() {
        if (!this._hasCustomFilters) {
            this._filters.clearFilters();
            this._filters.destroy();
        }
        this._disconnect.next();
        this._disconnect.complete();
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._dataQuery;
    /**
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._filters;
    /**
     * if set a custom filter plugins, do not delete all in disconnect() *
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._hasCustomFilters;
    /**
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._paginator;
    /**
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._sort;
    /**
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._selectAllByFilter$;
    /**
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._count$;
    /**
     * Used to react to internal changes of the paginator that are made by the data source itself.
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._internalPageChanges;
    /**
     * Stream emitting render data to the table (depends on ordered data changes).
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._renderData;
    /**
     * Used to react to internal changes of the paginator that are made by the data source itself.
     * @type {?}
     * @private
     */
    AkitaMatDataSource.prototype._disconnect;
    /**
     * Subscription to the changes that should trigger an update to the table's rendered rows, such
     * as filtering, sorting, pagination, or base data changes.
     * @type {?}
     */
    AkitaMatDataSource.prototype._renderChangesSubscription;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWtpdGEtbWF0LWRhdGEtc291cmNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYWtpdGEtZmlsdGVycy1wbHVnaW4vIiwic291cmNlcyI6WyJsaWIvYm9udXMvYWtpdGEtbWF0LWRhdGEtc291cmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sb0JBQW9CLENBQUM7QUFDOUMsT0FBTyxFQUFDLGVBQWUsRUFBRSxhQUFhLEVBQUUsS0FBSyxFQUFjLEVBQUUsRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ2xHLE9BQU8sRUFBaUMsS0FBSyxFQUFjLE1BQU0saUJBQWlCLENBQUM7QUFFbkYsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDM0QsT0FBTyxFQUFDLEdBQUcsRUFBRSxTQUFTLEVBQU0sTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQUluRCxNQUFNLE9BQU8sa0JBQXNFLFNBQVEsVUFBYTs7Ozs7Ozs7SUFZdEcsWUFBWSxLQUEwQyxFQUFFLFlBQXVDO1FBQzdGLEtBQUssRUFBRSxDQUFDO1FBeUZGLGVBQVUsR0FBaUIsSUFBSSxDQUFDO1FBQ2hDLFVBQUssR0FBWSxJQUFJLENBQUM7Ozs7UUFLYix5QkFBb0IsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDOzs7O1FBRTNDLGdCQUFXLEdBQUcsSUFBSSxlQUFlLENBQU0sRUFBRSxDQUFDLENBQUM7Ozs7UUFFM0MsZ0JBQVcsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDOzs7OztRQVFuRCwrQkFBMEIsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDO1FBMUc5QyxJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQztRQUV4QixJQUFJLENBQUMsUUFBUSxHQUFHLFlBQVksQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJLGtCQUFrQixDQUFPLEtBQUssQ0FBQyxDQUFDO1FBQ2xGLElB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Ozs7SUFFcEQsK0NBQW1DOzs7OztJQUNuQyx3Q0FBd0M7Ozs7O0lBQ3hDLG1DQUE4Qjs7Ozs7SUFFOUIsaURBQTZDOzs7OztJQUM3QyxxQ0FBeUM7Ozs7OztJQUV6QyxrREFBNEQ7Ozs7OztJQUU1RCx5Q0FBNEQ7Ozs7OztJQUU1RCx5Q0FBbUQ7Ozs7OztJQVFuRCx3REFBZ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0RhdGFTb3VyY2V9IGZyb20gJ0Bhbmd1bGFyL2Nkay90YWJsZSc7XG5pbXBvcnQge0JlaGF2aW9yU3ViamVjdCwgY29tYmluZUxhdGVzdCwgbWVyZ2UsIE9ic2VydmFibGUsIG9mLCBTdWJqZWN0LCBTdWJzY3JpcHRpb259IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtFbnRpdHlTdGF0ZSwgZ2V0RW50aXR5VHlwZSwgSUQsIE9yZGVyLCBRdWVyeUVudGl0eX0gZnJvbSAnQGRhdG9yYW1hL2FraXRhJztcbmltcG9ydCB7QWtpdGFGaWx0ZXJ9IGZyb20gJy4uL2FraXRhLWZpbHRlcnMtc3RvcmUnO1xuaW1wb3J0IHtBa2l0YUZpbHRlcnNQbHVnaW59IGZyb20gJy4uL2FraXRhLWZpbHRlcnMtcGx1Z2luJztcbmltcG9ydCB7bWFwLCB0YWtlVW50aWwsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtNYXRTb3J0LCBTb3J0fSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9zb3J0JztcbmltcG9ydCB7IE1hdFBhZ2luYXRvciwgUGFnZUV2ZW50IH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvcGFnaW5hdG9yJztcblxuZXhwb3J0IGNsYXNzIEFraXRhTWF0RGF0YVNvdXJjZTxTIGV4dGVuZHMgRW50aXR5U3RhdGUgPSBhbnksIEUgPSBnZXRFbnRpdHlUeXBlPFM+PiBleHRlbmRzIERhdGFTb3VyY2U8RT4ge1xuXG5cblxuXG4gIC8qKlxuICAgKiBEYXRhIHNvdXJjZSB0byB1c2UgYW4gQWtpdGEgRW50aXR5U3RvcmUgd2l0aCBhIE1hdGVyaWFsIHRhYmxlXG4gICAqIEBzZWUgOiBodHRwczovL21hdGVyaWFsLmFuZ3VsYXIuaW8vY29tcG9uZW50cy90YWJsZS9vdmVydmlld1xuICAgKlxuICAgKiBAcGFyYW0gcXVlcnkgc3RyaW5nIDogW01hbmRhdG9yeV0gdGhlIGFraXRhIFF1ZXJ5IEVudGl0eSwgeW91IHdhbiB0byB1c2UgdG8gdGhpcyBkYXRhIHNvdXJjZS5cbiAgICogQHBhcmFtIGFraXRhRmlsdGVycyBzdHJpbmcgW09wdGlvbmFsXSBJZiB5b3Ugd2FudCB0byBwcm92aWRlIGFuIEFraXRhRmlsdGVycyB0aGF0IHlvdSB1c2UgZXh0ZXJuYWxseS4gRWxzZSBpdCB3aWxsIGNyZWF0ZSBhIG5ldyBvbmUuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihxdWVyeTogUXVlcnlFbnRpdHk8Z2V0RW50aXR5VHlwZTxTPj4gfCBhbnksIGFraXRhRmlsdGVycz86IEFraXRhRmlsdGVyc1BsdWdpbjxTLCBFPikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5fZGF0YVF1ZXJ5ID0gcXVlcnk7XG5cbiAgICB0aGlzLl9maWx0ZXJzID0gYWtpdGFGaWx0ZXJzID8gYWtpdGFGaWx0ZXJzIDogbmV3IEFraXRhRmlsdGVyc1BsdWdpbjxTLCBFPihxdWVyeSk7XG4gICAgdGhpcy5faGFzQ3VzdG9tRmlsdGVycyA9ICEhYWtpdGFGaWx0ZXJzO1xuICAgIHRoaXMuX2NvdW50JCA9IG5ldyBCZWhhdmlvclN1YmplY3QoMCk7XG5cbiAgICBsZXQgY291bnQgPSAwO1xuICAgIC8vIEB0cy1pZ25vcmUgaWdub3JlLCBhcyB3aXRob3V0IG9wdGlvbnMsIHdlIHdpbGwgYWxsd2F5cyBoYXZlIGFuIEFycmF5LlxuICAgIHRoaXMuX3NlbGVjdEFsbEJ5RmlsdGVyJCA9IHRoaXMuX2ZpbHRlcnMuc2VsZWN0QWxsQnlGaWx0ZXJzKCk7XG4gICAgdGhpcy5fdXBkYXRlQ2hhbmdlU3Vic2NyaXB0aW9uKCk7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHNlYXJjaFF1ZXJ5IHRlaCBzdHJpbmcgdXNlIHRvIHNlYXJjaFxuICAgKi9cbiAgc2V0IGZpbHRlcihzZWFyY2hRdWVyeTogc3RyaW5nKSB7XG4gICAgdGhpcy5zZWFyY2ggPSBzZWFyY2hRdWVyeTtcbiAgfVxuXG4gIC8qKlxuICAgKiBmaWx0ZXIgYWxsIHRoZSBsaXN0IGJ5IGEgc2VhcmNoIHRlcm0uXG4gICAqXG4gICAqIHVzZSBsaWtlIGEgcHJvcGVydHkgOlxuICAgKiBha2l0YU1hdERhdGFTb3VyY2VJbnN0YW5jZS5zZWFyY2ggPSAndGVybSc7XG4gICAqIEBwYXJhbSBzZWFyY2hRdWVyeSB0aGUgc3RyaW5nIHVzZSB0byBzZWFyY2hcbiAgICovXG4gIHNldCBzZWFyY2goc2VhcmNoUXVlcnk6IHN0cmluZykge1xuICAgIGlmIChzZWFyY2hRdWVyeSA9PT0gJycpIHtcbiAgICAgIHRoaXMuX2ZpbHRlcnMucmVtb3ZlRmlsdGVyKCdzZWFyY2gnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fZmlsdGVycy5zZXRGaWx0ZXIoe2lkOiAnc2VhcmNoJywgdmFsdWU6IHNlYXJjaFF1ZXJ5fSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEluc3RhbmNlIG9mIHRoZSBNYXRTb3J0IGRpcmVjdGl2ZSB1c2VkIGJ5IHRoZSB0YWJsZSB0byBjb250cm9sIGl0cyBzb3J0aW5nLiBTb3J0IGNoYW5nZXNcbiAgICogZW1pdHRlZCBieSB0aGUgTWF0U29ydCB3aWxsIHRyaWdnZXIgYW4gdXBkYXRlIHRvIHRoZSB0YWJsZSdzIHJlbmRlcmVkIGRhdGEuXG4gICAqL1xuICBzZXQgc29ydChzb3J0OiBNYXRTb3J0KSB7XG4gICAgdGhpcy5fc29ydCA9IHNvcnQ7XG4gICAgc29ydC5zb3J0Q2hhbmdlLnBpcGUodGFrZVVudGlsKHRoaXMuX2Rpc2Nvbm5lY3QpKS5zdWJzY3JpYmUoKHNvcnRWYWx1ZTogU29ydCkgPT4ge1xuICAgICAgdGhpcy5fZmlsdGVycy5zZXRTb3J0Qnkoe1xuICAgICAgICBzb3J0Qnk6IHNvcnRWYWx1ZS5hY3RpdmUgYXMga2V5b2YgRSxcbiAgICAgICAgc29ydEJ5T3JkZXI6IHNvcnRWYWx1ZS5kaXJlY3Rpb24gPT09ICdkZXNjJyA/IE9yZGVyLkRFU0MgOiBPcmRlci5BU0NcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgc29ydC5pbml0aWFsaXplZC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy5zZXREZWZhdWx0U29ydChzb3J0LmFjdGl2ZSBhcyBrZXlvZiBFLCBzb3J0LmRpcmVjdGlvbiA9PT0gJ2Rlc2MnID8gT3JkZXIuREVTQyA6IE9yZGVyLkFTQyk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogSW5zdGFuY2Ugb2YgdGhlIE1hdFBhZ2luYXRvciBjb21wb25lbnQgdXNlZCBieSB0aGUgdGFibGUgdG8gY29udHJvbCB3aGF0IHBhZ2Ugb2YgdGhlIGRhdGEgaXNcbiAgICogZGlzcGxheWVkLiBQYWdlIGNoYW5nZXMgZW1pdHRlZCBieSB0aGUgTWF0UGFnaW5hdG9yIHdpbGwgdHJpZ2dlciBhbiB1cGRhdGUgdG8gdGhlXG4gICAqIHRhYmxlJ3MgcmVuZGVyZWQgZGF0YS5cbiAgICpcbiAgICogTm90ZSB0aGF0IHRoZSBkYXRhIHNvdXJjZSB1c2VzIHRoZSBwYWdpbmF0b3IncyBwcm9wZXJ0aWVzIHRvIGNhbGN1bGF0ZSB3aGljaCBwYWdlIG9mIGRhdGFcbiAgICogc2hvdWxkIGJlIGRpc3BsYXllZC4gSWYgdGhlIHBhZ2luYXRvciByZWNlaXZlcyBpdHMgcHJvcGVydGllcyBhcyB0ZW1wbGF0ZSBpbnB1dHMsXG4gICAqIGUuZy4gYFtwYWdlTGVuZ3RoXT0xMDBgIG9yIGBbcGFnZUluZGV4XT0xYCwgdGhlbiBiZSBzdXJlIHRoYXQgdGhlIHBhZ2luYXRvcidzIHZpZXcgaGFzIGJlZW5cbiAgICogaW5pdGlhbGl6ZWQgYmVmb3JlIGFzc2lnbmluZyBpdCB0byB0aGlzIGRhdGEgc291cmNlLlxuICAgKi9cbiAgZ2V0IHBhZ2luYXRvcigpOiBNYXRQYWdpbmF0b3Ige1xuICAgIHJldHVybiB0aGlzLl9wYWdpbmF0b3I7XG4gIH1cblxuICBzZXQgcGFnaW5hdG9yKHBhZ2luYXRvcjogTWF0UGFnaW5hdG9yKSB7XG4gICAgdGhpcy5fcGFnaW5hdG9yID0gcGFnaW5hdG9yO1xuICAgIHRoaXMuX3VwZGF0ZUNoYW5nZVN1YnNjcmlwdGlvbigpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIHVzZSBnZXQgYWtpdGFGaWx0ZXJzUGx1Z2luXG4gICAqL1xuICBnZXQgQWtpdGFGaWx0ZXJzKCk6IEFraXRhRmlsdGVyc1BsdWdpbjxTLCBFLCBhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5fZmlsdGVycztcbiAgfVxuICAvKipcbiAgICogQWNjZXNzIHRvIEFraXRhRmlsdGVyc1BsdWdpbnMsIHVzZWZ1bGwgdG8gaW50ZXJhY3Qgd2l0aCBhbGwgZmlsdGVyc1xuICAgKi9cbiAgZ2V0IGFraXRhRmlsdGVyc1BsdWdJbigpOiBBa2l0YUZpbHRlcnNQbHVnaW48UywgRT4ge1xuICAgIHJldHVybiB0aGlzLl9maWx0ZXJzO1xuICB9XG5cbiAgcHJpdmF0ZSBfZGF0YVF1ZXJ5OiBRdWVyeUVudGl0eTxFPjtcbiAgcHJpdmF0ZSByZWFkb25seSBfZmlsdGVyczogQWtpdGFGaWx0ZXJzUGx1Z2luPFMsIEU+O1xuICAvKiogaWYgc2V0IGEgY3VzdG9tIGZpbHRlciBwbHVnaW5zLCBkbyBub3QgZGVsZXRlIGFsbCBpbiBkaXNjb25uZWN0KCkgKiovXG4gIHByaXZhdGUgX2hhc0N1c3RvbUZpbHRlcnM6IGJvb2xlYW47XG4gIHByaXZhdGUgX3BhZ2luYXRvcjogTWF0UGFnaW5hdG9yID0gbnVsbDtcbiAgcHJpdmF0ZSBfc29ydDogTWF0U29ydCA9IG51bGw7XG5cbiAgcHJpdmF0ZSBfc2VsZWN0QWxsQnlGaWx0ZXIkOiBPYnNlcnZhYmxlPEVbXT47XG4gIHByaXZhdGUgX2NvdW50JDogQmVoYXZpb3JTdWJqZWN0PG51bWJlcj47XG4gIC8qKiBVc2VkIHRvIHJlYWN0IHRvIGludGVybmFsIGNoYW5nZXMgb2YgdGhlIHBhZ2luYXRvciB0aGF0IGFyZSBtYWRlIGJ5IHRoZSBkYXRhIHNvdXJjZSBpdHNlbGYuICovXG4gIHByaXZhdGUgcmVhZG9ubHkgX2ludGVybmFsUGFnZUNoYW5nZXMgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuICAvKiogU3RyZWFtIGVtaXR0aW5nIHJlbmRlciBkYXRhIHRvIHRoZSB0YWJsZSAoZGVwZW5kcyBvbiBvcmRlcmVkIGRhdGEgY2hhbmdlcykuICovXG4gIHByaXZhdGUgcmVhZG9ubHkgX3JlbmRlckRhdGEgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEVbXT4oW10pO1xuICAvKiogVXNlZCB0byByZWFjdCB0byBpbnRlcm5hbCBjaGFuZ2VzIG9mIHRoZSBwYWdpbmF0b3IgdGhhdCBhcmUgbWFkZSBieSB0aGUgZGF0YSBzb3VyY2UgaXRzZWxmLiAqL1xuICBwcml2YXRlIHJlYWRvbmx5IF9kaXNjb25uZWN0ID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuXG5cbiAgLyoqXG4gICAqIFN1YnNjcmlwdGlvbiB0byB0aGUgY2hhbmdlcyB0aGF0IHNob3VsZCB0cmlnZ2VyIGFuIHVwZGF0ZSB0byB0aGUgdGFibGUncyByZW5kZXJlZCByb3dzLCBzdWNoXG4gICAqIGFzIGZpbHRlcmluZywgc29ydGluZywgcGFnaW5hdGlvbiwgb3IgYmFzZSBkYXRhIGNoYW5nZXMuXG4gICAqL1xuICBfcmVuZGVyQ2hhbmdlc1N1YnNjcmlwdGlvbiA9IFN1YnNjcmlwdGlvbi5FTVBUWTtcblxuICBwcml2YXRlIF91cGRhdGVDb3VudCh2YWx1ZTogRVtdKSB7XG4gICAgY29uc3QgY291bnQgPSB2YWx1ZS5sZW5ndGggPyB2YWx1ZS5sZW5ndGggOiAwO1xuICAgIGlmIChjb3VudCAhPT0gdGhpcy5fY291bnQkLmdldFZhbHVlKCkpIHtcbiAgICAgIHRoaXMuX2NvdW50JC5uZXh0KGNvdW50KTtcblxuICAgICAgdGhpcy5fdXBkYXRlUGFnaW5hdG9yKGNvdW50KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUGFnaW5hdGUgdGhlIGRhdGEgKGNsaWVudC1zaWRlKS4gSWYgeW91J3JlIHVzaW5nIHNlcnZlci1zaWRlIHBhZ2luYXRpb24sXG4gICAqIHRoaXMgd291bGQgYmUgcmVwbGFjZWQgYnkgcmVxdWVzdGluZyB0aGUgYXBwcm9wcmlhdGUgZGF0YSBmcm9tIHRoZSBzZXJ2ZXIuXG4gICAqL1xuICBwcml2YXRlIF9wYWdlRGF0YShkYXRhOiBFW10pIHtcbiAgICB0aGlzLl91cGRhdGVDb3VudChkYXRhKTtcbiAgICBpZiAoIXRoaXMucGFnaW5hdG9yKSB7IHJldHVybiBkYXRhOyB9XG5cbiAgICBjb25zdCBzdGFydEluZGV4ID0gdGhpcy5wYWdpbmF0b3IucGFnZUluZGV4ICogdGhpcy5wYWdpbmF0b3IucGFnZVNpemU7XG4gICAgcmV0dXJuIGRhdGEuc2xpY2Uoc3RhcnRJbmRleCwgc3RhcnRJbmRleCArIHRoaXMucGFnaW5hdG9yLnBhZ2VTaXplKTtcbiAgfVxuXG4gIC8qKlxuICAgKiAgYWRkIGEgZmlsdGVyIHRvIGZpbHRlcnMgcGx1Z2luc1xuICAgKi9cbiAgYWRkRmlsdGVyKGZpbHRlcjogUGFydGlhbDxBa2l0YUZpbHRlcjxTPj4pOiB2b2lkIHtcbiAgICB0aGlzLl9maWx0ZXJzLnNldEZpbHRlcihmaWx0ZXIpO1xuICB9XG5cbiAgLyoqXG4gICAqICBhZGQgYSBmaWx0ZXIgdG8gZmlsdGVycyBwbHVnaW5zXG4gICAqL1xuICBzZXRGaWx0ZXIoZmlsdGVyOiBQYXJ0aWFsPEFraXRhRmlsdGVyPFM+Pik6IHZvaWQge1xuICAgIHRoaXMuX2ZpbHRlcnMuc2V0RmlsdGVyKGZpbHRlcik7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGEgQWtpdGFGaWx0ZXJcbiAgICovXG4gIHJlbW92ZUZpbHRlcihpZDogSUQpOiB2b2lkIHtcbiAgICB0aGlzLl9maWx0ZXJzLnJlbW92ZUZpbHRlcihpZCk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgYWxsIGZpbHRlcnNcbiAgICovXG4gIGNsZWFyRmlsdGVycygpOiB2b2lkIHtcbiAgICB0aGlzLl9maWx0ZXJzLmNsZWFyRmlsdGVycygpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBmaWx0ZXIgdmFsdWUsIHJldHVybiBudWxsLCBpZiB2YWx1ZSBub3QgYXZhaWxhYmxlXG4gICAqL1xuICBnZXRGaWx0ZXJWYWx1ZTxWID0gRT4oaWQ6IHN0cmluZyk6IFYgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5fZmlsdGVycy5nZXRGaWx0ZXJWYWx1ZShpZCk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSBkZWZhdWx0IHNvcnRcbiAgICogQHBhcmFtIHNvcnRDb2x1bW4gdGhlIGNvbHVtIG5hbWUgcHJlc2VudCBpbiB5b3VyIG9iamVjdFxuICAgKiBAcGFyYW0gZGlyZWN0aW9uIHN0cmluZyB0aGUgZGlyZWN0aW9uIGZvciBzb3J0aW5nIChhc2Mgb3IgZGVzYykuIERlZmF1bHQgYXNjLlxuICAgKi9cbiAgcHVibGljIHNldERlZmF1bHRTb3J0KFxuICAgIHNvcnRDb2x1bW46IGtleW9mIEUsXG4gICAgZGlyZWN0aW9uOiAnYXNjJyB8ICdkZXNjJyA9ICdhc2MnXG4gICkge1xuICAgIHRoaXMuX2ZpbHRlcnMuc2V0U29ydEJ5KHtcbiAgICAgIHNvcnRCeTogc29ydENvbHVtbixcbiAgICAgIHNvcnRCeU9yZGVyOiBkaXJlY3Rpb24gPT09ICdkZXNjJyA/IE9yZGVyLkRFU0MgOiBPcmRlci5BU0NcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWxlY3QgQ291bnQgZmlsdGVyZWQgcmVzdWx0cy5cbiAgICovXG4gIHNlbGVjdENvdW50KCk6IE9ic2VydmFibGU8bnVtYmVyPiB7XG4gICAgcmV0dXJuIHRoaXMuX2NvdW50JC5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWxlY3QgQ291bnQgZmlsdGVyZWQgcmVzdWx0cy5cbiAgICovXG4gIGdldENvdW50KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX2NvdW50JC5nZXRWYWx1ZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFN1YnNjcmliZSB0byBjaGFuZ2VzIHRoYXQgc2hvdWxkIHRyaWdnZXIgYW4gdXBkYXRlIHRvIHRoZSB0YWJsZSdzIHJlbmRlcmVkIHJvd3MuIFdoZW4gdGhlXG4gICAqIGNoYW5nZXMgb2NjdXIsIHByb2Nlc3MgdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIGZpbHRlciwgc29ydCwgYW5kIHBhZ2luYXRpb24gYWxvbmcgd2l0aFxuICAgKiB0aGUgcHJvdmlkZWQgYmFzZSBkYXRhIGFuZCBzZW5kIGl0IHRvIHRoZSB0YWJsZSBmb3IgcmVuZGVyaW5nLlxuICAgKi9cbiAgX3VwZGF0ZUNoYW5nZVN1YnNjcmlwdGlvbigpIHtcbiAgICAvLyBTb3J0aW5nIGFuZC9vciBwYWdpbmF0aW9uIHNob3VsZCBiZSB3YXRjaGVkIGlmIE1hdFNvcnQgYW5kL29yIE1hdFBhZ2luYXRvciBhcmUgcHJvdmlkZWQuXG4gICAgLy8gVGhlIGV2ZW50cyBzaG91bGQgZW1pdCB3aGVuZXZlciB0aGUgY29tcG9uZW50IGVtaXRzIGEgY2hhbmdlIG9yIGluaXRpYWxpemVzLCBvciBpZiBub1xuICAgIC8vIGNvbXBvbmVudCBpcyBwcm92aWRlZCwgYSBzdHJlYW0gd2l0aCBqdXN0IGEgbnVsbCBldmVudCBzaG91bGQgYmUgcHJvdmlkZWQuXG4gICAgLy8gVGhlIGBzb3J0Q2hhbmdlYCBhbmQgYHBhZ2VDaGFuZ2VgIGFjdHMgYXMgYSBzaWduYWwgdG8gdGhlIGNvbWJpbmVMYXRlc3RzIGJlbG93IHNvIHRoYXQgdGhlXG4gICAgLy8gcGlwZWxpbmUgY2FuIHByb2dyZXNzIHRvIHRoZSBuZXh0IHN0ZXAuIE5vdGUgdGhhdCB0aGUgdmFsdWUgZnJvbSB0aGVzZSBzdHJlYW1zIGFyZSBub3QgdXNlZCxcbiAgICAvLyB0aGV5IHB1cmVseSBhY3QgYXMgYSBzaWduYWwgdG8gcHJvZ3Jlc3MgaW4gdGhlIHBpcGVsaW5lLlxuXG4gICAgY29uc3QgcGFnZUNoYW5nZTogT2JzZXJ2YWJsZTxQYWdlRXZlbnR8bnVsbHx2b2lkPiA9IHRoaXMuX3BhZ2luYXRvciA/XG4gICAgICBtZXJnZShcbiAgICAgICAgdGhpcy5fcGFnaW5hdG9yLnBhZ2UsXG4gICAgICAgIHRoaXMuX2ludGVybmFsUGFnZUNoYW5nZXMsXG4gICAgICAgIHRoaXMuX3BhZ2luYXRvci5pbml0aWFsaXplZFxuICAgICAgKSBhcyBPYnNlcnZhYmxlPFBhZ2VFdmVudHx2b2lkPiA6XG4gICAgICBvZihudWxsKTtcblxuICAgIGNvbnN0IHBhZ2luYXRlZERhdGEgPSBjb21iaW5lTGF0ZXN0KHRoaXMuX3NlbGVjdEFsbEJ5RmlsdGVyJCwgcGFnZUNoYW5nZSlcbiAgICAgIC5waXBlKG1hcCgoW2RhdGFdKSA9PiB0aGlzLl9wYWdlRGF0YShkYXRhKSkpO1xuICAgIC8vIFdhdGNoZWQgZm9yIHBhZ2VkIGRhdGEgY2hhbmdlcyBhbmQgc2VuZCB0aGUgcmVzdWx0IHRvIHRoZSB0YWJsZSB0byByZW5kZXIuXG4gICAgdGhpcy5fcmVuZGVyQ2hhbmdlc1N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIHRoaXMuX3JlbmRlckNoYW5nZXNTdWJzY3JpcHRpb24gPSBwYWdpbmF0ZWREYXRhLnBpcGUodGFrZVVudGlsKHRoaXMuX2Rpc2Nvbm5lY3QpKS5zdWJzY3JpYmUoZGF0YSA9PiB0aGlzLl9yZW5kZXJEYXRhLm5leHQoZGF0YSkpO1xuICAgIHRoaXMuX2ludGVybmFsUGFnZUNoYW5nZXMubmV4dCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgdGhlIHBhZ2luYXRvciB0byByZWZsZWN0IHRoZSBsZW5ndGggb2YgdGhlIGZpbHRlcmVkIGRhdGEsIGFuZCBtYWtlcyBzdXJlIHRoYXQgdGhlIHBhZ2VcbiAgICogaW5kZXggZG9lcyBub3QgZXhjZWVkIHRoZSBwYWdpbmF0b3IncyBsYXN0IHBhZ2UuIFZhbHVlcyBhcmUgY2hhbmdlZCBpbiBhIHJlc29sdmVkIHByb21pc2UgdG9cbiAgICogZ3VhcmQgYWdhaW5zdCBtYWtpbmcgcHJvcGVydHkgY2hhbmdlcyB3aXRoaW4gYSByb3VuZCBvZiBjaGFuZ2UgZGV0ZWN0aW9uLlxuICAgKi9cbiAgX3VwZGF0ZVBhZ2luYXRvcihmaWx0ZXJlZERhdGFMZW5ndGg6IG51bWJlcikge1xuICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4ge1xuICAgICAgY29uc3QgcGFnaW5hdG9yID0gdGhpcy5wYWdpbmF0b3I7XG5cbiAgICAgIGlmICghcGFnaW5hdG9yKSB7IHJldHVybjsgfVxuXG4gICAgICBwYWdpbmF0b3IubGVuZ3RoID0gZmlsdGVyZWREYXRhTGVuZ3RoO1xuXG4gICAgICAvLyBJZiB0aGUgcGFnZSBpbmRleCBpcyBzZXQgYmV5b25kIHRoZSBwYWdlLCByZWR1Y2UgaXQgdG8gdGhlIGxhc3QgcGFnZS5cbiAgICAgIGlmIChwYWdpbmF0b3IucGFnZUluZGV4ID4gMCkge1xuICAgICAgICBjb25zdCBsYXN0UGFnZUluZGV4ID0gTWF0aC5jZWlsKHBhZ2luYXRvci5sZW5ndGggLyBwYWdpbmF0b3IucGFnZVNpemUpIC0gMSB8fCAwO1xuICAgICAgICBjb25zdCBuZXdQYWdlSW5kZXggPSBNYXRoLm1pbihwYWdpbmF0b3IucGFnZUluZGV4LCBsYXN0UGFnZUluZGV4KTtcblxuICAgICAgICBpZiAobmV3UGFnZUluZGV4ICE9PSBwYWdpbmF0b3IucGFnZUluZGV4KSB7XG4gICAgICAgICAgcGFnaW5hdG9yLnBhZ2VJbmRleCA9IG5ld1BhZ2VJbmRleDtcblxuICAgICAgICAgIC8vIFNpbmNlIHRoZSBwYWdpbmF0b3Igb25seSBlbWl0cyBhZnRlciB1c2VyLWdlbmVyYXRlZCBjaGFuZ2VzLFxuICAgICAgICAgIC8vIHdlIG5lZWQgb3VyIG93biBzdHJlYW0gc28gd2Uga25vdyB0byBzaG91bGQgcmUtcmVuZGVyIHRoZSBkYXRhLlxuICAgICAgICAgIHRoaXMuX2ludGVybmFsUGFnZUNoYW5nZXMubmV4dCgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRnVuY3Rpb24gdXNlZCBieSBtYXRUYWJsZSB0byBzdWJzY3JpYmUgdG8gdGhlIGRhdGFcbiAgICovXG4gIGNvbm5lY3QoKTogT2JzZXJ2YWJsZTxFW10+IHtcbiAgICByZXR1cm4gdGhpcy5fcmVuZGVyRGF0YTtcbiAgfVxuXG5cbiAgLyoqXG4gICAqIFVzZWQgYnkgdGhlIE1hdFRhYmxlLiBDYWxsZWQgd2hlbiBpdCBpcyBkZXN0cm95ZWQuIE5vLW9wLlxuICAgKiBAZG9jcy1wcml2YXRlXG4gICAqL1xuICBkaXNjb25uZWN0KCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5faGFzQ3VzdG9tRmlsdGVycykge1xuICAgICAgdGhpcy5fZmlsdGVycy5jbGVhckZpbHRlcnMoKTtcbiAgICAgIHRoaXMuX2ZpbHRlcnMuZGVzdHJveSgpO1xuICAgIH1cbiAgICB0aGlzLl9kaXNjb25uZWN0Lm5leHQoKTtcbiAgICB0aGlzLl9kaXNjb25uZWN0LmNvbXBsZXRlKCk7XG4gIH1cbn1cbiJdfQ==