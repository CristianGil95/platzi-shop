!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@datorama/akita"),require("rxjs"),require("rxjs/operators"),require("@angular/cdk/table")):"function"==typeof define&&define.amd?define("akita-filters-plugin",["exports","@datorama/akita","rxjs","rxjs/operators","@angular/cdk/table"],e):e((t=t||self)["akita-filters-plugin"]={},t.akita,t.rxjs,t.rxjs.operators,t.ng.cdk.table)}(this,function(t,e,r,i,n){"use strict";var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function s(t,e){function r(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var a=function(){return(a=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function l(t,e,r,i){var n,o=arguments.length,s=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,r,i);else for(var a=t.length-1;a>=0;a--)(n=t[a])&&(s=(o<3?n(s):o>3?n(e,r,s):n(e,r))||s);return o>3&&s&&Object.defineProperty(e,r,s),s}function u(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}function c(t){var e="function"==typeof Symbol&&t[Symbol.iterator],r=0;return e?e.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}}function p(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var i,n,o=r.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return s}function f(t,r,i,n){return e.isObject(t)&&e.isString(n.value)?y(n.value,t):e.isDefined(n.value)?n.value===t:!!t}function y(t,r){return e.isString(t)&&Object.keys(r).some(function(i){return e.isString(r[i])&&r[i].toLocaleLowerCase().includes(t.toLocaleLowerCase())})}function h(t){var r,i=t.id?t.id:e.guid(),n=t.name||(t.value&&t.id?(r=t.id.toString()).charAt(0).toUpperCase()+r.substr(1)+": "+t.value.toString():void 0);return!t.predicate&&t.value&&(t.predicate=f),a({id:i,name:n,hide:!1,order:10,server:!1},t)}var d=function(t){function r(e){return t.call(this,void 0,{name:e})||this}return s(r,t),r.ctorParameters=function(){return[{type:String}]},r=l([e.StoreConfig({name:"filters"}),u("design:paramtypes",[String])],r)}(e.EntityStore),g=function(t){function r(e){var r=t.call(this,e)||this;return r.store=e,r}return s(r,t),r.ctorParameters=function(){return[{type:d}]},r=l([e.QueryConfig({sortBy:"order",sortByOrder:e.Order.ASC}),u("design:paramtypes",[d])],r)}(e.QueryEntity);var _=function(t){function n(e,r){void 0===r&&(r={});var i=t.call(this,e,r.entityIds)||this;return i.query=e,i.params=r,i._server=!1,i.params=a({filtersStoreName:i.getStore().storeName+"Filters"},r),i._filtersStore=new d(i.params.filtersStoreName),i._filtersQuery=new g(i._filtersStore),i._selectFilters$=i.filtersQuery.selectAll({sortBy:"order"}),i._selectFiltersAll$=i.filtersQuery.selectAll({sortBy:"order",filterBy:function(t){return!t.hide}}),i._selectSortBy$=i.filtersQuery.select(function(t){return t&&t.sort?t.sort:null}),i}return s(n,t),Object.defineProperty(n.prototype,"filtersStore",{get:function(){return this._filtersStore},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"filtersQuery",{get:function(){return this._filtersQuery},enumerable:!0,configurable:!0}),n.prototype.withServer=function(t,e){var i=this;void 0===e&&(e={}),this._server=!0,this._selectFilters$=this._filtersQuery.selectAll({sortBy:"order",filterBy:function(t){return!t.server}});var n=[];return n.push(this._filtersQuery.selectAll({sortBy:"order",filterBy:function(t){return t.server}})),e.withSort&&n.push(this.selectSortBy()),r.merge(n).subscribe(function(){var n=t(i.getNormalizedFilters(e));!1!==n&&r.isObservable(n)&&n.subscribe(function(t){i.getStore().set(t)})}),this},n.prototype.hasServer=function(){return this._server},n.prototype.selectFilters=function(){return this._selectFiltersAll$},n.prototype.getFilters=function(){return this._filtersQuery.getAll({filterBy:function(t){return!t.hide}})},n.prototype.getServerFilters=function(){return this._server?this._filtersQuery.getAll({filterBy:function(t){return!t.server}}):this.getFilters()},n.prototype.selectAllByFilters=function(t){var e=this;return t&&t.asObject?r.combineLatest(this._selectFilters$,this.getQuery().selectAll(t)).pipe(i.map(function(t){var r=p(t,2),i=r[0],n=r[1];return e._applyFiltersForHashMap(n,i)})):r.combineLatest(this._selectFilters$,this.getQuery().selectAll(t),this.selectSortBy()).pipe(i.map(function(t){var r=p(t,3),i=r[0],n=r[1],o=r[2],s=n;return e._applyFiltersForArray(s,i,o)}))},n.prototype.setFilter=function(t){this._server&&e.isUndefined(typeof t.server)&&(t.server=!0);var r=h(t);this.filtersStore.upsert(r.id,r)},n.prototype.removeFilter=function(t){this.filtersStore.remove(t)},n.prototype.clearFilters=function(){this.filtersStore.remove()},n.prototype.getFilterValue=function(t){if(this.filtersQuery.hasEntity(t)){var e=this.filtersQuery.getEntity(t);return e.value?e.value:null}return null},n.prototype.getSortValue=function(){var t=this.filtersQuery.getValue();return t.sort?t.sort:null},n.prototype.selectSortBy=function(){return this._selectSortBy$},n.prototype.setSortBy=function(t){this.filtersStore.update({sort:t})},n.prototype.getNormalizedFilters=function(t){var e,r;void 0===t&&(t={});var i={};t=a({sortByKey:"sortBy",sortByOrderKey:"sortByOrder"},t);try{for(var n=c(this.getServerFilters()),o=n.next();!o.done;o=n.next()){var s=o.value;i[s.id]=s.value}}catch(t){e={error:t}}finally{try{o&&!o.done&&(r=n.return)&&r.call(n)}finally{if(e)throw e.error}}if(t.withSort){var l=this.getSortValue();i[t.sortByKey]=l.sortBy,i[t.sortByOrderKey]=l.sortByOrder}return t.asQueryParams?this._serialize(i):i},n.prototype.destroy=function(){this.clearFilters()},n.prototype.getQuery=function(){return this.query},n.prototype.getStore=function(){return this.getQuery().__store__},n.prototype._serialize=function(t){return Object.keys(t).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])}).join("&")},n.prototype._applyFiltersForArray=function(t,r,i){var n=t;if(0!==r.length&&(n=t.filter(function(t,e,i){return r.every(function(r){return!r.predicate||!!r.predicate(t,e,i,r)})})),i&&i.sortBy){var o=e.isFunction(i.sortBy)?i.sortBy:e.compareValues(i.sortBy,i.sortByOrder);n=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(p(arguments[e]));return t}(n.sort(function(e,r){return o(e,r,t)}))}return n},n.prototype._applyFiltersForHashMap=function(t,e){var r=this;if(0===e.length)return t;var i={};return Object.keys(t).forEach(function(n,o){var s=t[n];r._applyFiltersForOneEntity(e,s,o,t)&&(i[n]=s)}),i},n.prototype._applyFiltersForOneEntity=function(t,e,r,i){return t.every(function(t){return!t.predicate||!!t.predicate(e,r,i,t)})},n.prototype.instantiatePlugin=function(t){return null},n}(e.EntityCollectionPlugin);var v=function(t){function n(e,i){var n=t.call(this)||this;n._paginator=null,n._sort=null,n._internalPageChanges=new r.Subject,n._renderData=new r.BehaviorSubject([]),n._disconnect=new r.Subject,n._renderChangesSubscription=r.Subscription.EMPTY,n._dataQuery=e,n._filters=i||new _(e),n._hasCustomFilters=!!i,n._count$=new r.BehaviorSubject(0);return n._selectAllByFilter$=n._filters.selectAllByFilters(),n._updateChangeSubscription(),n}return s(n,t),Object.defineProperty(n.prototype,"filter",{set:function(t){this.search=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"search",{set:function(t){""===t?this._filters.removeFilter("search"):this._filters.setFilter({id:"search",value:t})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"sort",{set:function(t){var r=this;this._sort=t,t.sortChange.pipe(i.takeUntil(this._disconnect)).subscribe(function(t){r._filters.setSortBy({sortBy:t.active,sortByOrder:"desc"===t.direction?e.Order.DESC:e.Order.ASC})}),t.initialized.subscribe(function(){r.setDefaultSort(t.active,"desc"===t.direction?e.Order.DESC:e.Order.ASC)})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"paginator",{get:function(){return this._paginator},set:function(t){this._paginator=t,this._updateChangeSubscription()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"AkitaFilters",{get:function(){return this._filters},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"akitaFiltersPlugIn",{get:function(){return this._filters},enumerable:!0,configurable:!0}),n.prototype._updateCount=function(t){var e=t.length?t.length:0;e!==this._count$.getValue()&&(this._count$.next(e),this._updatePaginator(e))},n.prototype._pageData=function(t){if(this._updateCount(t),!this.paginator)return t;var e=this.paginator.pageIndex*this.paginator.pageSize;return t.slice(e,e+this.paginator.pageSize)},n.prototype.addFilter=function(t){this._filters.setFilter(t)},n.prototype.setFilter=function(t){this._filters.setFilter(t)},n.prototype.removeFilter=function(t){this._filters.removeFilter(t)},n.prototype.clearFilters=function(){this._filters.clearFilters()},n.prototype.getFilterValue=function(t){return this._filters.getFilterValue(t)},n.prototype.setDefaultSort=function(t,r){void 0===r&&(r="asc"),this._filters.setSortBy({sortBy:t,sortByOrder:"desc"===r?e.Order.DESC:e.Order.ASC})},n.prototype.selectCount=function(){return this._count$.asObservable()},n.prototype.getCount=function(){return this._count$.getValue()},n.prototype._updateChangeSubscription=function(){var t=this,e=this._paginator?r.merge(this._paginator.page,this._internalPageChanges,this._paginator.initialized):r.of(null),n=r.combineLatest(this._selectAllByFilter$,e).pipe(i.map(function(e){var r=p(e,1)[0];return t._pageData(r)}));this._renderChangesSubscription.unsubscribe(),this._renderChangesSubscription=n.pipe(i.takeUntil(this._disconnect)).subscribe(function(e){return t._renderData.next(e)}),this._internalPageChanges.next()},n.prototype._updatePaginator=function(t){var e=this;Promise.resolve().then(function(){var r=e.paginator;if(r&&(r.length=t,r.pageIndex>0)){var i=Math.ceil(r.length/r.pageSize)-1||0,n=Math.min(r.pageIndex,i);n!==r.pageIndex&&(r.pageIndex=n,e._internalPageChanges.next())}})},n.prototype.connect=function(){return this._renderData},n.prototype.disconnect=function(){this._hasCustomFilters||(this._filters.clearFilters(),this._filters.destroy()),this._disconnect.next(),this._disconnect.complete()},n}(n.DataSource);t.AkitaFiltersPlugin=_,t.AkitaFiltersQuery=g,t.AkitaFiltersStore=d,t.AkitaMatDataSource=v,t.createFilter=h,t.defaultFilter=f,t.searchFilter=y,t.searchFilterIn=function(t,r,i){return e.isString(t)&&e.isString(i)&&e.isString(r[i])&&r[i].toLocaleLowerCase().includes(t.toLocaleLowerCase())},Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=akita-filters-plugin.umd.min.js.map